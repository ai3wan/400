<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –°–≤–æ–¥–Ω—ã–π –î–∞—à–±–æ—Ä–¥ ‚Äî –û–ö–†</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
<style>
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Regular.otf') format('opentype');font-weight:400;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Light.otf') format('opentype');font-weight:300;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Medium.otf') format('opentype');font-weight:500;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Bold.otf') format('opentype');font-weight:700;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Extrabold.otf') format('opentype');font-weight:800;font-style:normal;font-display:swap}
  :root{
    --c-white:#FFFFFF;
    --c-misty-rose:#F3DCE7;
    --c-tiffany-blue:#92DAD9;
    --c-dark-cyan:#038681;
    --c-midnight-green:#135457;
    --c-space-cadet:#2A3043;
    --c-vermilion:#F34C3F;
    --c-bg:var(--c-white);
    --c-card:var(--c-white);
    --c-text:var(--c-space-cadet);
    --c-primary:var(--c-dark-cyan);
    --c-accent:var(--c-vermilion);
    --c-secondary:var(--c-tiffany-blue);
  }
  [data-theme="dark"]{
    --c-bg:#0b1218;
    --c-card:#111827;
    --c-text:#E5E7EB;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Moscow Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-text)}
  .container{max-width:1400px;margin:0 auto;padding:20px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
  .title{font-size:32px;font-weight:700;color:var(--c-primary)}
  .controls{display:flex;gap:12px;align-items:center}
  .card{background:var(--c-card);border-radius:16px;box-shadow:0 2px 8px rgba(42,48,67,.08);padding:16px;border:1px solid rgba(42,48,67,.06)}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
  .kpi-card{text-align:center;padding:20px;background:var(--c-card);border:1px solid rgba(3,134,129,.1)}
  .kpi-value{font-size:28px;font-weight:700;color:var(--c-primary);margin-bottom:4px}
  .kpi-label{font-size:14px;color:var(--c-text);opacity:0.7}
  .delta{font-size:12px;margin-top:4px}
  .delta.up{color:var(--c-primary)} .delta.down{color:var(--c-accent)}
  .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
  .charts-grid.components{margin-top:28px}
  .chart-card{min-height:400px}
  .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--c-text)}
  .chart-container{width:100%;height:350px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:rgba(3,134,129,.12);color:var(--c-primary)}
  .legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
  select, button{padding:8px 10px;border-radius:10px;border:1px solid rgba(42,48,67,.12);background:var(--c-card);color:var(--c-text)}
  .accent{color:var(--c-primary)}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px;border:1px solid rgba(42,48,67,.1)}
  table{width:100%;border-collapse:collapse}
  th, td{padding:10px;border-bottom:1px solid rgba(42,48,67,.08);text-align:left}
  th{font-weight:600;color:var(--c-text);opacity:0.9}
  tr:hover{background:rgba(146,218,217,.05)}
</style>
</head>
<body>
  <!-- Auth Overlay -->
  <div id="authOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:99999;">
    <div style="background:var(--c-card);padding:28px 24px;border-radius:16px;min-width:320px;max-width:420px;">
      <div style="font-size:20px;font-weight:700;margin-bottom:14px;">–í—Ö–æ–¥</div>
      <div style="font-size:13px;opacity:0.8;margin-bottom:12px;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É</div>
      <input id="authInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.1);background:var(--c-card);color:var(--c-text);margin-bottom:12px;">
      <div style="display:flex;gap:10px;">
        <button id="authSubmit" style="flex:1;">–í–æ–π—Ç–∏</button>
        <button id="authReset" style="">–°–±—Ä–æ—Å</button>
      </div>
      <div id="authError" style="color:var(--c-red);font-size:12px;margin-top:8px;display:none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
  </div>

  <div class="container" id="appContainer" style="display:none;">
    <div class="header">
      <h1 class="title">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –°–≤–æ–¥–Ω—ã–π –î–∞—à–±–æ—Ä–¥ ‚Äî –û–ö–†</h1>
      <div class="controls">
        <button id="themeBtn">üåô</button>
        <button id="refreshBtn">üîÑ</button>
        <button id="logoutBtn" title="–í—ã–π—Ç–∏">üö™</button>
    </div>
    </div>

    <!-- KPI (OKR) -->
    <div class="kpi-grid">
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-inwork">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –û–ö–† –≤ —Ä–∞–±–æ—Ç–µ</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-tz">0</div>
        <div class="kpi-label">–ù–∞ —ç—Ç–∞–ø–µ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-oo">0</div>
        <div class="kpi-label">–ù–∞ —ç—Ç–∞–ø–µ –û–ø—ã—Ç–Ω–æ–≥–æ –æ–±—Ä–∞–∑—Ü–∞</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-pi">0</div>
        <div class="kpi-label">–ù–∞ —ç—Ç–∞–ø–µ –ü—Ä–∏–µ–º–æ—á–Ω—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-ready">0</div>
        <div class="kpi-label">–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –û–ö–†</div>
      </div>
    </div>

    <!-- Phase Progress Pie Charts -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:20px;">
      <div class="card">
        <div class="chart-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
        <div id="phase-pie-tz" class="chart-container"></div>
      </div>
      <div class="card">
        <div class="chart-title">–û–ø—ã—Ç–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü</div>
        <div id="phase-pie-oo" class="chart-container"></div>
      </div>
      <div class="card">
        <div class="chart-title">–ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è</div>
        <div id="phase-pie-pi" class="chart-container"></div>
      </div>
    </div>

    <div class="charts-grid" style="margin-top:20px;">
      <div class="card chart-card">
        <div class="chart-title">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –û–ö–† (–¢–ó / –û–û / –ü–ò / –í—ã–ø–æ–ª–Ω–µ–Ω–æ)</div>
        <div id="okrPhasePie" class="chart-container"></div>
      </div>
    </div>

    <div id="okrPhaseDetails" class="card" style="margin-top:20px;display:none;">
      <div class="chart-title" id="okrPhaseDetailsTitle" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span id="okrPhaseDetailsPhase">–î–µ—Ç–∞–ª–∏ –ø–æ —Ñ–∞–∑–µ</span>
        <button id="okrPhaseDetailsClose" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text);">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>–°–∏—Å—Ç–µ–º–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
              <th>–ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
            </tr>
          </thead>
          <tbody id="okrPhaseDetailsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="chart-title" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span id="okrRiskTitle">üö® –†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - [0]</span>
        <button id="okrRiskToggle" aria-label="toggle" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/–°–≤–µ—Ä–Ω—É—Ç—å" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text);font-size:16px;line-height:1;">‚ñ∏</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>–°–∏—Å—Ç–µ–º–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–§–∞–∑–∞</th>
              <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th>
              <th>–ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
            </tr>
          </thead>
          <tbody id="okrRiskSoonBody"></tbody>
        </table>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
      <div class="card">
        <div class="chart-title">–¢–æ–ø-5 —Ä–∏—Å–∫–æ–≤ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>
        <div id="okrRiskCompanyBar" class="chart-container"></div>
      </div>
      <div class="card">
        <div class="chart-title">–†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: –ø–æ –º–µ—Å—è—Ü–∞–º</div>
        <div id="okrRiskMonthPie" class="chart-container"></div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="chart-title">–†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: Treemap –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>
      <div id="okrRiskCompanyTreemap" class="chart-container" style="height:400px;"></div>
    </div>
    
    </div>
  
  <!-- Loading indicator -->
  <div id="loading" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
      <div style="font-size:18px;font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

<script>
// --- Simple front-only auth gate ---
const AUTH_KEY = 'vsm400_auth_ok';
const AUTH_PASS = 'vsm400';
function showApp(){document.getElementById('authOverlay').style.display='none';document.getElementById('appContainer').style.display='';}
function showAuth(){document.getElementById('appContainer').style.display='none';document.getElementById('authOverlay').style.display='flex';}
function initAuth(){
  const ok = localStorage.getItem(AUTH_KEY)==='1';
  if(ok){showApp();}else{showAuth();}
  document.getElementById('authSubmit').onclick=()=>{const v=(document.getElementById('authInput').value||'').trim();if(v===AUTH_PASS){localStorage.setItem(AUTH_KEY,'1');showApp();init();}else{const e=document.getElementById('authError');e.style.display='';setTimeout(()=>e.style.display='none',1500);}};
  document.getElementById('authReset').onclick=()=>{document.getElementById('authInput').value='';};
  document.getElementById('logoutBtn').onclick=()=>{localStorage.removeItem(AUTH_KEY);location.reload();};
}

let OKR={};
async function loadData(){const res=await fetch('/api/okr/operational-summary');if(!res.ok)throw new Error('HTTP '+res.status);OKR=await res.json();}
function setKPI(){
  const k = OKR.kpi || {};
  document.getElementById('okr-kpi-inwork').innerText = (k.total_in_work || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-tz').innerText = (k.phase_tz || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-oo').innerText = (k.phase_oo || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-pi').innerText = (k.phase_pi || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-ready').innerText = (k.total_ready || 0).toLocaleString('ru-RU');
}
async function loadPhaseProgress(){
  try{
    const res = await fetch('/api/okr/phase-progress');
    if(!res.ok) return;
    const data = await res.json();
    const phases = data.phases || [];
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–∞–π—á–∞—Ä—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
    phases.forEach(phaseData => {
      const phase = phaseData.phase;
      const progress = phaseData.progress || 0;
      const statuses = phaseData.statuses || [];
      
      let chartId = '';
      if(phase === '–¢–ó') chartId = 'phase-pie-tz';
      else if(phase === '–û–û') chartId = 'phase-pie-oo';
      else if(phase === '–ü–ò') chartId = 'phase-pie-pi';
      else return;
      
      const elDom = document.getElementById(chartId);
      if(!elDom) return;
      
      const el = echarts.init(elDom);
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–π—á–∞—Ä—Ç–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
      const statusMap = {
        '–Ω–µ –Ω–∞—á–∞—Ç–æ': { name: '–ù–µ –Ω–∞—á–∞—Ç–æ', color: '#F34C3F' },
        '–≤ —Ä–∞–±–æ—Ç–µ': { name: '–í —Ä–∞–±–æ—Ç–µ', color: '#038681' },
        '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ': { name: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#92DAD9' },
        '–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ': { name: '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#F34C3F' }
      };
      
      const pieData = [];
      statuses.forEach(s => {
        const statusName = (s.status || '').trim();
        const statusKey = statusName.toLowerCase();
        const statusInfo = statusMap[statusKey] ||
          (statusKey.includes('–Ω–µ –≤—ã–ø–æ–ª–Ω') || statusKey.includes('–Ω–µ –Ω–∞—á–∞—Ç–æ') ? { name: statusName || '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#F34C3F' } : { name: statusName, color: '#6b7280' });
        pieData.push({
          name: statusInfo.name,
          value: s.count || 0,
          itemStyle: { color: statusInfo.color }
        });
      });
      
      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –ø–∞–π—á–∞—Ä—Ç
      if(pieData.length === 0){
        el.setOption({
          title: {
            text: `${progress.toFixed(1)}%`,
            left: 'center',
            top: 'center',
            textStyle: {
              fontSize: 32,
              fontWeight: 'bold',
              fontFamily: 'Moscow Sans, sans-serif'
            }
          },
          series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            data: [{ value: 0, name: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }],
            itemStyle: { color: '#e5e7eb' }
          }]
        }, true);
        return;
      }
      
      el.setOption({
        tooltip: {
          trigger: 'item',
          formatter: (params) => {
            return `${params.name}<br/>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${params.value}`;
          }
        },
        legend: {
          type: 'scroll',
          bottom: 0,
          textStyle: {
            fontFamily: 'Moscow Sans, sans-serif',
            fontSize: 12
          }
        },
        graphic: [{
          type: 'text',
          left: 'center',
          top: 'center',
          style: {
            text: `${progress.toFixed(1)}%`,
            fontSize: 32,
            fontWeight: 'bold',
            fontFamily: 'Moscow Sans, sans-serif',
            fill: '#1f2937'
          }
        }],
        series: [{
          type: 'pie',
          radius: ['40%', '70%'],
          center: ['50%', '50%'],
          itemStyle: {
            borderRadius: 6,
            borderColor: '#fff',
            borderWidth: 2
          },
          label: {
            show: false
          },
          labelLine: {
            show: false
          },
          data: pieData
        }]
      }, true);
      
      window.addEventListener('resize', () => el.resize());
    });
  }catch(e){ console.error('loadPhaseProgress error:', e); }
}
async function okrPhasePieChart(){
  const el=echarts.init(document.getElementById('okrPhasePie'));
  const res=await fetch('/api/okr/summary-by-phase');
  const payload= res.ok ? await res.json() : {items:[]};
  const raw=(payload.items||[]);
  // –ü–æ—Ä—è–¥–æ–∫ —Ñ–∞–∑ –∏ –±–∞–∫–µ—Ç–æ–≤
  const phaseOrder=["–¢–ó","–û–û","–ü–ò","–í—ã–ø–æ–ª–Ω–µ–Ω–æ"];
  const full={"–¢–ó":"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ","–û–û":"–û–ø—ã—Ç–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü","–ü–ò":"–ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è","–í—ã–ø–æ–ª–Ω–µ–Ω–æ":"–í—ã–ø–æ–ª–Ω–µ–Ω–æ"};
  const bucketOrder=["0","25","50","75","100"];
  const bucketLabels={"0":"0%","25":"25%","50":"50%","75":"75%","100":"100%"};
  const bucketColors={"0":"#F34C3F","25":"#F3DCE7","50":"#92DAD9","75":"#038681","100":"#135457"};

  const sorted = phaseOrder
    .map(p => raw.find(x => (x.phase||'').trim() === p) || {phase:p,total:0,buckets:{"0":0,"25":0,"50":0,"75":0,"100":0}});

  const categories = sorted.map(item => full[item.phase] || item.phase || '‚Äî');

  const series = bucketOrder.map(bucket => ({
    name: bucketLabels[bucket],
    type: 'bar',
    stack: 'total',
    emphasis: { focus: 'series' },
    itemStyle: {
      color: bucketColors[bucket] || '#6b7280',
      borderRadius: bucket === '100' ? [6,6,0,0] : 0
    },
    data: sorted.map(item => (item.buckets && typeof item.buckets[bucket] !== 'undefined') ? item.buckets[bucket] : 0)
  }));

  // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–π–±–ª—ã —Å –æ–±—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º –±–∞–∫–µ—Ç–µ
  const lastSeries = series[series.length - 1];
  if(lastSeries){
    lastSeries.label = {
      show: true,
      position: 'top',
      formatter: (params) => {
        const total = sorted[params.dataIndex]?.total || 0;
        return total ? total.toString() : '';
      },
      fontFamily:'Moscow Sans, sans-serif'
    };
  }

  el.setOption({
    tooltip:{
      trigger:'axis',
      axisPointer:{type:'shadow'},
      formatter:(params)=>{
        const idx=params[0]?.dataIndex ?? 0;
        const phaseKey = sorted[idx]?.phase;
        const phaseName = full[phaseKey] || phaseKey || '‚Äî';
        let lines = [`<strong>${phaseName}</strong>`];
        params.forEach(p=>{
          if(p.value){
            lines.push(`${p.marker} ${p.seriesName}: ${p.value}`);
          }
        });
        const total = sorted[idx]?.total || 0;
        lines.push(`–ò—Ç–æ–≥–æ: ${total}`);
        return lines.join('<br/>');
      }
    },
    legend:{
      bottom:0,
      textStyle:{fontFamily:'Moscow Sans, sans-serif'},
      data: bucketOrder.map(b => bucketLabels[b])
    },
    grid:{
      left:'3%',
      right:'4%',
      bottom:'10%',
      containLabel:true
    },
    xAxis:{
      type:'category',
      data:categories,
      axisLabel:{fontFamily:'Moscow Sans, sans-serif'}
    },
    yAxis:{
      type:'value',
      name:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
      nameTextStyle:{fontFamily:'Moscow Sans, sans-serif'}
    },
    series
  });

  // –ö–ª–∏–∫ –ø–æ —Ñ–∞–∑–µ –¥–ª—è drill-down
  el.off('click');
  el.on('click', async (params) => {
    const idx = params.dataIndex;
    const phaseKey = sorted[idx]?.phase;
    if(phaseKey){
      await loadPhaseDetails(phaseKey, full[phaseKey] || phaseKey);
    }
  });

  window.addEventListener('resize',()=>el.resize());
}
async function loadPhaseDetails(phase, fullPhaseName){
  try{
    const res=await fetch(`/api/okr/details-by-phase?phase=${encodeURIComponent(phase)}`);
    const payload=res.ok ? await res.json() : {items:[]};
    const rows=payload.items||[];
    const body=document.getElementById('okrPhaseDetailsBody');
    const titleSpan=document.getElementById('okrPhaseDetailsPhase');
    const detailsEl=document.getElementById('okrPhaseDetails');
    if(titleSpan){ titleSpan.innerText=`–î–µ—Ç–∞–ª–∏ –ø–æ —Ñ–∞–∑–µ: ${fullPhaseName}`; }
    const html=rows.map(r=>{
      const dt=(r.end_plan_date||'').slice(0,10)||'‚Äî';
      const progress=Number(r.current_progress||0);
      return `<tr><td>${(r.system_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.supplier_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${dt}</td><td>${progress}%</td></tr>`;
    }).join('');
    body.innerHTML=html||'<tr><td colspan="4" style="opacity:.6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    detailsEl.style.display='block';
  }catch(e){console.error('loadPhaseDetails error:',e);}
}
let RISK_EXPANDED = false;
let RISK_ROWS = [];
async function loadRiskSoon(){
  try{
    const res=await fetch('/api/okr/risk-soon');
    const payload = res.ok ? await res.json() : {items:[]};
    const rows = payload.items || [];
    RISK_ROWS = rows;
    const title=document.getElementById('okrRiskTitle');
    if(title){ title.textContent = `üö® –†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - [${rows.length}]`; }
    const body=document.getElementById('okrRiskSoonBody');
    const toShow = RISK_EXPANDED ? rows : rows.slice(0,5);
    const now = new Date();
    const nowYM = now.getFullYear()*100 + now.getMonth();
    const html = toShow.map(r=>{
      const dtStr = (r.end_plan_date||'');
      const dt = dtStr ? new Date(dtStr) : null;
      const ym = dt && !isNaN(dt.getTime()) ? dt.getFullYear()*100 + dt.getMonth() : null;
      const isPastMonth = ym !== null && ym < nowYM;
      const rowStyle = isPastMonth ? ' style="background: rgba(243,76,63,0.10);"' : '';
      const dtDisp = (dtStr||'').slice(0,10) || '‚Äî';
      const progress=Number(r.current_progress||0);
      return `<tr${rowStyle}><td>${(r.system_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.supplier_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.phase||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${dtDisp}</td><td>${progress}%</td></tr>`;
    }).join('');
    const moreRow = (!RISK_EXPANDED && rows.length>5) ? '<tr><td colspan="5" style="text-align:center; opacity:.6;">...</td></tr>' : '';
    body.innerHTML = html + moreRow || '<tr><td colspan="5" style="opacity:.6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    const btn = document.getElementById('okrRiskToggle');
    if(btn){ btn.textContent = RISK_EXPANDED ? '‚ñæ' : '‚ñ∏'; }
    // render company bar chart
    okrRiskCompanyBarChart();
    okrRiskMonthPieChart();
    okrRiskCompanyTreemapChart();
  }catch(e){ console.error('loadRiskSoon error:', e); }
}
function okrRiskCompanyBarChart(){
  try{
    const elDom = document.getElementById('okrRiskCompanyBar');
    if(!elDom){ return; }
    const el = echarts.init(elDom);
    // aggregate by supplier_name and collect systems
    const map = new Map();
    (RISK_ROWS||[]).forEach(r=>{
      const key = (r.supplier_name||'‚Äî');
      if(!map.has(key)){
        map.set(key, {count:0, systems:new Set()});
      }
      map.get(key).count++;
      if(r.system_name) map.get(key).systems.add(r.system_name);
    });
    // convert to array, sort desc, take top 5
    const dataArr = Array.from(map.entries())
      .map(([name,info])=>({name,value:info.count,systems:Array.from(info.systems)}))
      .sort((a,b)=>b.value-a.value)
      .slice(0,5);
    
    if(dataArr.length === 0){
      el.setOption({
        title: { text:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', left:'center', top:'middle', textStyle:{ color:'#999', fontSize:14 } }
      }, true);
      return;
    }
    
    const names = dataArr.map(d=>d.name);
    const values = dataArr.map(d=>d.value);
    const systemsMap = new Map(dataArr.map(d=>[d.name, d.systems]));
    
    el.setOption({
      tooltip: {
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        formatter: (params) => {
          const p = params[0];
          const companyName = p.name;
          const systems = systemsMap.get(companyName) || [];
          let tooltipText = `${companyName}<br/>–ü—Ä–æ—Å—Ä–æ—á–µ–∫: ${p.value}`;
          if(systems.length > 0){
            tooltipText += '<br/><br/>–°–∏—Å—Ç–µ–º—ã:<br/>' + systems.map(s=>`‚Ä¢ ${s}`).join('<br/>');
          }
          return tooltipText;
        }
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
      },
      xAxis: {
        type: 'value',
        name: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–∫'
      },
      yAxis: {
        type: 'category',
        data: names,
        inverse: true
      },
      series: [{
        name: '–ü—Ä–æ—Å—Ä–æ—á–µ–∫',
        type: 'bar',
        data: values,
        itemStyle: {
          color: (params) => {
            const maxVal = Math.max(...values);
            const minVal = Math.min(...values);
            if(maxVal === minVal) return '#F34C3F';
            const ratio = (params.value - minVal) / (maxVal - minVal);
            // –≥—Ä–∞–¥–∏–µ–Ω—Ç: —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (min) -> –∞–ª—ã–π (max)
            // —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π #92DAD9 = rgb(146,218,217), –∞–ª—ã–π #F34C3F = rgb(243,76,63)
            const r = Math.round(146 + ratio * (243 - 146));
            const g = Math.round(218 - ratio * (218 - 76));
            const b = Math.round(217 - ratio * (217 - 63));
            return `rgb(${r},${g},${b})`;
          }
        },
        label: {
          show: true,
          position: 'right',
          formatter: '{c}'
        }
      }]
    }, true);
    window.addEventListener('resize',()=>el.resize());
  }catch(e){ console.error('okrRiskCompanyBarChart error:', e); }
}
function okrRiskMonthPieChart(){
  try{
    const elDom = document.getElementById('okrRiskMonthPie');
    if(!elDom){ return; }
    const el = echarts.init(elDom);
    // aggregate by month from end_plan_date
    const map = new Map();
    (RISK_ROWS||[]).forEach(r=>{
      const dt = r.end_plan_date || '';
      if(dt){
        const d = new Date(dt);
        if(!isNaN(d.getTime())){
          const monthKey = d.toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
          const sortKey = d.getFullYear() * 100 + d.getMonth(); // –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
          if(!map.has(monthKey)){
            map.set(monthKey, {count:0, sortKey});
          }
          map.get(monthKey).count++;
        }
      }
    });
    // convert to array and sort by date (asc)
    const monthData = Array.from(map.entries())
      .map(([name,info])=>({name, value:info.count, sortKey:info.sortKey}))
      .sort((a,b)=>a.sortKey - b.sortKey);

    const hasData = monthData.length > 0;

    const now = new Date();
    const currentYM = now.getFullYear() * 100 + now.getMonth();
    
    const pieData = monthData.map(m => {
      let color;
      if(m.sortKey < currentYM){
        // –ü—Ä–æ—à–µ–¥—à–∏–µ –º–µ—Å—è—Ü—ã - –∞–ª—ã–π
        color = '#F34C3F';
      }else if(m.sortKey === currentYM){
        // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü - —Ç–µ–º–Ω–æ-–±–∏—Ä—é–∑–æ–≤—ã–π
        color = '#038681';
      }else{
        // –ë—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã - —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π
        color = '#92DAD9';
      }
      return {
        name: m.name,
        value: m.value,
        sortKey: m.sortKey,
        itemStyle: { color }
      };
    });

    el.setOption({
      tooltip:{
        trigger:'item',
        formatter:(params)=>`${params.name}: ${params.value} (${params.percent}%)`
      },
      legend:{
        type:'scroll',
        bottom:0,
        textStyle:{ fontFamily:'Moscow Sans, sans-serif' }
      },
      title: hasData ? undefined : { text:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', left:'center', top:'middle', textStyle:{ color:'#999', fontSize:14 } },
      series:[{
        type:'pie',
        radius:['40%','70%'],
        itemStyle:{borderRadius:6,borderColor:'#fff',borderWidth:1},
        label: {
          show: true,
          formatter: (params) => {
            return `{bold|${params.value}}\n${params.name}`;
          },
          fontSize: 12,
          fontFamily: 'Moscow Sans, sans-serif',
          rich: {
            bold: {
              fontSize: 18,
              fontWeight: 'bold',
              fontFamily: 'Moscow Sans, sans-serif'
            }
          }
        },
        data: pieData
      }]
    }, true);
    window.addEventListener('resize',()=>el.resize());
  }catch(e){ console.error('okrRiskMonthPieChart error:', e); }
}
function okrRiskCompanyTreemapChart(){
  try{
    const elDom = document.getElementById('okrRiskCompanyTreemap');
    if(!elDom){ return; }
    const el = echarts.init(elDom);
    // aggregate by supplier_name
    const map = new Map();
    (RISK_ROWS||[]).forEach(r=>{
      const key = (r.supplier_name||'‚Äî');
      map.set(key, (map.get(key)||0)+1);
    });
    // convert to array and get min/max for color mapping
    const dataArr = Array.from(map.entries()).map(([name,count])=>({name,value:count}));
    if(dataArr.length === 0){
      el.setOption({
        title: { text:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', left:'center', top:'middle', textStyle:{ color:'#999', fontSize:14 } }
      }, true);
      return;
    }
    const values = dataArr.map(d=>d.value);
    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);
    // color function: —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (min) -> –∞–ª—ã–π (max)
    const getColor = (val) => {
      if(minVal === maxVal) return '#92DAD9'; // —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π if all same
      const ratio = (val - minVal) / (maxVal - minVal);
      // —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (#92DAD9) to –∞–ª—ã–π (#F34C3F)
      const r = Math.round(146 + ratio * (243 - 146));
      const g = Math.round(218 - ratio * (218 - 76));
      const b = Math.round(217 - ratio * (217 - 63));
      return `rgb(${r},${g},${b})`;
    };
    // add color to each item
    const treemapData = dataArr.map(d=>({
      name: d.name,
      value: d.value,
      itemStyle: { color: getColor(d.value) }
    }));
    el.setOption({
      tooltip: {
        trigger: 'item',
        formatter: (info) => {
          const data = info.data;
          return `${data.name} - ${data.value} –ø—Ä–æ—Å—Ä–æ—á–µ–∫`;
        }
      },
      series: [{
        type: 'treemap',
        data: treemapData,
        roam: false,
        nodeClick: false,
        breadcrumb: { show: false },
        label: {
          show: true,
          formatter: params => params.name,
          fontSize: 12,
          color: '#555',
          textStyle: {
            fontFamily: 'Moscow Sans, sans-serif'
          }
        },
        itemStyle: {
          borderColor: '#fff',
          borderWidth: 2,
          gapWidth: 2
        },
        emphasis: {
          itemStyle: {
            borderColor: '#333',
            borderWidth: 3
          },
          label: { 
            color: '#555',
            textStyle: {
              fontFamily: 'Moscow Sans, sans-serif'
            }
          }
        }
      }]
    }, true);
    window.addEventListener('resize',()=>el.resize());
  }catch(e){ console.error('okrRiskCompanyTreemapChart error:', e); }
}
// Toggle handler
const riskToggleBtn = document.getElementById('okrRiskToggle');
if(riskToggleBtn){ riskToggleBtn.onclick = async ()=>{ RISK_EXPANDED = !RISK_EXPANDED; await loadRiskSoon(); }; }
async function init(){try{await loadData();setKPI();await loadPhaseProgress();await okrPhasePieChart();await loadRiskSoon();document.getElementById('loading').style.display='none';}catch(e){console.error(e);document.getElementById('loading').innerHTML='<div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;"><div style="font-size:48px;margin-bottom:16px;">‚ùå</div><div style="font-size:18px;font-weight:600;color:var(--c-accent);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div><div style="margin-top:12px;">'+e.message+'</div></div>';}}
document.getElementById('themeBtn').onclick=()=>{const h=document.documentElement;const t=h.getAttribute('data-theme');const n=t==='dark'?'light':'dark';h.setAttribute('data-theme',n);document.getElementById('themeBtn').textContent=n==='dark'?'‚òÄÔ∏è':'üåô';};
document.getElementById('refreshBtn').onclick=()=>{document.getElementById('loading').style.display='flex';init();};
const closeBtn=document.getElementById('okrPhaseDetailsClose');
if(closeBtn){ closeBtn.onclick=()=>{ const el=document.getElementById('okrPhaseDetails'); if(el){ el.style.display='none'; } }; }
initAuth();
if(localStorage.getItem(AUTH_KEY)==='1'){init();}
</script>
</body>
</html>
