<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–¶–µ–Ω—Ç—Ä –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –í–°–ú400</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<style>
  :root{--c-teal:#16BDCA;--c-blue:#2563EB;--c-red:#EF4444;--c-bg:#f8fafc;--c-card:#fff;--c-text:#0f172a}
  [data-theme="dark"]{--c-bg:#0b1218;--c-card:#111827;--c-text:#E5E7EB}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-text)}
  .container{max-width:1400px;margin:0 auto;padding:20px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
  .title{font-size:32px;font-weight:700;background:linear-gradient(90deg,var(--c-teal),var(--c-blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .controls{display:flex;gap:12px;align-items:center}
  .card{background:var(--c-card);border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.12);padding:16px}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
  .kpi-card{text-align:center;padding:20px}
  .kpi-value{font-size:28px;font-weight:700;color:var(--c-teal);margin-bottom:4px}
  .kpi-label{font-size:14px;color:var(--c-text);opacity:0.7}
  .delta{font-size:12px;margin-top:4px}
  .delta.up{color:var(--c-teal)} .delta.down{color:var(--c-red)}
  .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
  .charts-grid.components{margin-top:28px}
  .chart-card{min-height:400px}
  .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--c-text)}
  .chart-container{width:100%;height:350px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px; background:rgba(37,99,235,.12); color:var(--c-blue)}
  .legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
  select, button{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text)}
  .accent{background: linear-gradient(90deg, var(--c-teal), var(--c-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px; border:1px solid rgba(0,0,0,.1)}
</style>
</head>
<body>
<div class="container">
    <div class="header">
      <h1 class="title">–¶–µ–Ω—Ç—Ä –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –í–°–ú400</h1>
      <div class="controls">
        <button id="themeBtn">üåô</button>
        <button id="refreshBtn">üîÑ</button>
    </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-ido">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –ò–î–û</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-ifr">0</div>
        <div class="kpi-label">–ú–µ–¥–∏–∞–Ω–Ω—ã–π –ò–§–†</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-ipd">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –ò–ü–î</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-capital">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –∫–∞–ø–∏—Ç–∞–ª</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-low-risk">0</div>
        <div class="kpi-label">–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫</div>
      </div>
    </div>

    <!-- Charts: Suppliers/Companies -->
    <h2 class="chart-title" style="margin-top:8px;">–î–∞—à–±–æ—Ä–¥ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º</h2>
    <div class="charts-grid">
      <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º -->
      <div class="card chart-card">
        <div class="chart-title">–ü–æ—Å—Ç–∞–≤—â–∏–∫–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</div>
        <div id="regionChart" class="chart-container"></div>
    </div>

      <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–∞—Ä–∫-—Ä–∏—Å–∫—É -->
      <div class="card chart-card">
        <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–∞—Ä–∫-—Ä–∏—Å–∫—É</div>
        <div id="riskChart" class="chart-container"></div>
      </div>
    </div>

    <!-- Components KPI (–º–∞—Å—Ç–µ—Ä-—Ü–∏—Ñ—Ä—ã –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º) -->
    <h2 class="chart-title" style="margin-top:24px;">–î–∞—à–±–æ—Ä–¥ –ø–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º</h2>
    <div class="kpi-grid">
      <div class="card kpi-card">
        <div class="kpi-value" id="cmp-kpi-total">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="cmp-kpi-qty">0</div>
        <div class="kpi-label">–°—É–º–º–∞—Ä–Ω–æ–µ quantity</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="cmp-kpi-types">0</div>
        <div class="kpi-label">–¢–∏–ø–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="cmp-kpi-included">0</div>
        <div class="kpi-label">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö included_in_name</div>
      </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ included_in_name -->
    <div class="card" style="margin-bottom:20px;display:flex;gap:12px;align-items:center;">
      <div style="font-weight:600;">–§–∏–ª—å—Ç—Ä –ø–æ –≤–∫–ª—é—á–µ–Ω–∏—é (included_in_name):</div>
      <select id="cmpFilter" style="min-width:260px">
        <option value="">–í—Å–µ –≤–∫–ª—é—á–µ–Ω–∏—è</option>
      </select>
      <button id="cmpFilterReset">–°–±—Ä–æ—Å–∏—Ç—å</button>
    </div>

    <!-- Charts: Components (–Ω–∏–∂–µ –¥–∞—à–±–æ—Ä–¥–∞ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º) -->
    <div class="charts-grid components">
      <div class="card chart-card">
        <div class="chart-title">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –¢–æ–ø-15 –≤–∫–ª—é—á–µ–Ω–∏–π (included_in_name)</div>
        <div id="cmpTopIncluded" class="chart-container"></div>
      </div>

      <div class="card chart-card">
        <div class="chart-title">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º (object_type)</div>
        <div id="cmpByType" class="chart-container"></div>
      </div>

      <div class="card chart-card">
        <div class="chart-title">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: —Ç–æ–ø –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤ –ø–æ —á–∏—Å–ª—É –ø–æ–∑–∏—Ü–∏–π</div>
        <div id="cmpTopSuppliers" class="chart-container"></div>
      </div>

      <div class="card chart-card">
        <div class="chart-title">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
        <div id="cmpTimeline" class="chart-container"></div>
      </div>
    </div>
    </div>
  
  <!-- Loading indicator -->
  <div id="loading" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
      <div style="font-size:18px;font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

<script>
let DATA = {};
let CMP = {};
let CMP_BASE = {};
let CMP_SELECTED = "";

async function loadData() {
  try {
    const response = await fetch('/400/api/dashboard-data');
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    DATA = await response.json();
    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', DATA);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    throw error;
  }
}

async function loadComponents() {
  const base = '/400/api/components/metrics';
  const params = new URLSearchParams();
  if (CMP_SELECTED) params.set('included_in_name', CMP_SELECTED);
  params.set('_ts', String(Date.now())); // cache busting
  const res = await fetch(base + '?' + params.toString(), { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP '+res.status+' on components');
  CMP = await res.json();
}

function setCmpKPI() {
  const k = CMP.kpi || {};
  document.getElementById('cmp-kpi-total').innerText = (k.total_components||0).toLocaleString('ru-RU');
  document.getElementById('cmp-kpi-qty').innerText = (k.total_quantity||0).toLocaleString('ru-RU');
  document.getElementById('cmp-kpi-types').innerText = (k.unique_object_types||0).toLocaleString('ru-RU');
  document.getElementById('cmp-kpi-included').innerText = (k.unique_included_in_names||0).toLocaleString('ru-RU');
}

function setKPI() {
  document.getElementById('kpi-total').innerText = (DATA.kpi?.total_companies || 0).toLocaleString('ru-RU');
  document.getElementById('kpi-avg-ido').innerText = (DATA.kpi?.avg_ido || 0).toFixed(1);
  document.getElementById('kpi-avg-ifr').innerText = (DATA.kpi?.avg_ifr || 0).toFixed(1);
  document.getElementById('kpi-avg-ipd').innerText = (DATA.kpi?.avg_ipd || 0).toFixed(1);
  document.getElementById('kpi-avg-capital').innerText = ((DATA.kpi?.avg_capital || 0) / 1000000).toFixed(1) + '–ú';
  document.getElementById('kpi-low-risk').innerText = (DATA.kpi?.low_risk_count || 0).toLocaleString('ru-RU');
}

function riskChart() {
  const el = echarts.init(document.getElementById('riskChart'));
  const data = DATA.companies_by_risk || [];
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Ü–≤–µ—Ç–∞–º–∏ (–ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏)
  const colors = [
    '#86efac',  // –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –∑–µ–ª–µ–Ω—ã–π (–ù–∏–∑–∫–∏–π)
    '#fca5a5',  // –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π (–°—Ä–µ–¥–Ω–∏–π) ‚Äî –ø–æ–º–µ–Ω—è–ª–∏ —Å –≤—ã—Å–æ–∫–∏–º
    '#fde68a',  // –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –∂–µ–ª—Ç—ã–π (–í—ã—Å–æ–∫–∏–π) ‚Äî –ø–æ–º–µ–Ω—è–ª–∏ —Å–æ —Å—Ä–µ–¥–Ω–∏–º
    '#f87171'   // –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –ø–∞—Å—Ç–µ–ª—å–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π (–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)
  ];
  
  const chartData = data.map((x, index) => ({
    name: x.spark_risk || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
    value: x.count || 0,
    itemStyle: { 
      color: colors[index % colors.length],
      borderRadius: 6, 
      borderColor: '#fff', 
      borderWidth: 1 
    }
  }));
  
  el.setOption({
    tooltip: { 
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
      type: 'scroll',
      orient: 'horizontal',
      left: 'center',
      top: 'bottom',
      width: '80%',
      data: chartData.map(item => item.name),
      textStyle: {
        color: '#374151',
        fontSize: 12
      },
      itemWidth: 14,
      itemHeight: 14,
      itemGap: 15,
      formatter: function(name) {
        return name;
      }
    },
    series: [{
      name: '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–ø–∞—Ä–∫-—Ä–∏—Å–∫—É',
      type: 'pie',
      radius: ['30%', '60%'],
      center: ['50%', '45%'],
      data: chartData,
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      },
      label: {
        show: true,
        formatter: '{b}: {c}',
        fontSize: 11,
        color: '#374151'
      },
      labelLine: {
        show: true,
        lineStyle: {
          color: '#374151'
        }
      }
    }]
  });
  
  window.addEventListener('resize', () => el.resize());
}

function regionChart() {
  const el = echarts.init(document.getElementById('regionChart'));
  const data = DATA.companies_by_region || [];
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Ü–≤–µ—Ç–∞–º–∏
  const colors = [
    '#16BDCA', '#2563EB', '#10b981', '#f59e0b', '#ef4444', 
    '#8b5cf6', '#06b6d4', '#84cc16', '#f97316', '#ec4899',
    '#6366f1', '#14b8a6', '#eab308', '#dc2626', '#9333ea'
  ];
  
  const chartData = data.map((x, index) => ({
    name: x.region || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
    value: x.count || 0,
    itemStyle: { 
      color: colors[index % colors.length],
      borderRadius: 6, 
      borderColor: '#fff', 
      borderWidth: 1 
    }
  }));
  
  el.setOption({
    tooltip: { 
      trigger: 'item',
      formatter: '{a} <br/>{b}: {c} ({d}%)'
    },
    legend: {
      type: 'scroll',
      orient: 'horizontal',
      left: 'center',
      top: 'bottom',
      width: '80%',
      data: chartData.map(item => item.name),
      textStyle: {
        color: '#374151',
        fontSize: 12
      },
      itemWidth: 14,
      itemHeight: 14,
      itemGap: 15,
      formatter: function(name) {
        return name;
      }
    },
    series: [{
      name: '–ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º',
      type: 'pie',
      radius: ['30%', '60%'],
      center: ['50%', '45%'],
      data: chartData,
      emphasis: {
        itemStyle: {
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowColor: 'rgba(0, 0, 0, 0.5)'
        }
      },
      label: {
        show: true,
        formatter: '{b}: {c}',
        fontSize: 11,
        color: '#374151'
      },
      labelLine: {
        show: true,
        lineStyle: {
          color: '#374151'
        }
      }
    }]
  });
  
  window.addEventListener('resize', () => el.resize());
}

function cmpTopIncludedChart() {
  const elDom = document.getElementById('cmpTopIncluded');
  const prev = echarts.getInstanceByDom(elDom); if (prev) prev.dispose();
  const el = echarts.init(elDom);
  const data = CMP.top_included_in || [];
  el.setOption({
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: data.map(x => x.included_in_name || '‚Äî'), axisLabel: { interval: 0, rotate: 30 } },
    yAxis: { type: 'value' },
    series: [{ type: 'bar', data: data.map(x => x.count||0), itemStyle: { borderRadius: [4,4,0,0] } }]
  });
  window.addEventListener('resize', () => el.resize());
}

function cmpByTypeChart() {
  const elDom = document.getElementById('cmpByType');
  const prev = echarts.getInstanceByDom(elDom); if (prev) prev.dispose();
  const el = echarts.init(elDom);
  const data = CMP.by_object_type || [];
  el.setOption({
    tooltip: { trigger: 'item' },
    series: [{ type: 'pie', radius: ['40%','70%'], itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 1 }, data: data.map(x => ({ name: x.object_type || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', value: x.count||0 })) }]
  });
  window.addEventListener('resize', () => el.resize());
}

function cmpTopSuppliersChart() {
  const elDom = document.getElementById('cmpTopSuppliers');
  const prev = echarts.getInstanceByDom(elDom); if (prev) prev.dispose();
  const el = echarts.init(elDom);
  const data = CMP.top_suppliers || [];
  el.setOption({
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: data.map(x => x.supplier || '‚Äî'), axisLabel: { interval: 0, rotate: 30 } },
    yAxis: { type: 'value' },
    series: [{ type: 'bar', data: data.map(x => x.count||0), itemStyle: { borderRadius: [4,4,0,0] } }]
  });
  window.addEventListener('resize', () => el.resize());
}

function cmpTimelineChart() {
  const elDom = document.getElementById('cmpTimeline');
  const prev = echarts.getInstanceByDom(elDom); if (prev) prev.dispose();
  const el = echarts.init(elDom);
  const data = CMP.timeline_by_month || [];
  const labels = data.map(x => (x.month || '').slice(0,10));
  el.setOption({
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: labels },
    yAxis: { type: 'value' },
    series: [{ type: 'line', smooth: true, data: data.map(x => x.count||0) }]
  });
  window.addEventListener('resize', () => el.resize());
}


async function init() {
  try {
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
    await Promise.all([loadData(), (async () => { CMP_SELECTED = ""; await loadComponents(); CMP_BASE = CMP; })()]);
    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', DATA);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ try-catch
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º setKPI...');
    setKPI(); 
      console.log('setKPI –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ setKPI:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º regionChart...');
      regionChart(); 
      console.log('regionChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ regionChart:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º riskChart...');
      riskChart();
      console.log('riskChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ riskChart:', e);
    }

    // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: KPI + –≥—Ä–∞—Ñ–∏–∫–∏
    try { setCmpKPI(); } catch (e) { console.error(e); }
    try { cmpTopIncludedChart(); } catch (e) { console.error(e); }
    try { cmpByTypeChart(); } catch (e) { console.error(e); }
    try { cmpTopSuppliersChart(); } catch (e) { console.error(e); }
    try { cmpTimelineChart(); } catch (e) { console.error(e); }

    // –ù–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç –≤–∫–ª—é—á–µ–Ω–∏–π (—Ç–æ–ø-15 –∏–∑ –±–∞–∑–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–∏)
    try {
      const sel = document.getElementById('cmpFilter');
      const list = (CMP_BASE.top_included_in || []).map(x => x.included_in_name).filter(Boolean);
      sel.innerHTML = '<option value="">–í—Å–µ –≤–∫–ª—é—á–µ–Ω–∏—è</option>' + list.map(n => `<option value="${n.replaceAll('"','&quot;')}">${n}</option>`).join('');
    } catch (e) { console.error(e); }

    // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('loading').style.display = 'none';
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    console.error('Stack trace:', error.stack);
    document.getElementById('loading').innerHTML = '<div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;"><div style="font-size:48px;margin-bottom:16px;">‚ùå</div><div style="font-size:18px;font-weight:600;color:var(--c-red);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div><div style="margin-top:12px;">'+error.message+'</div></div>';
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.getElementById('themeBtn').onclick = () => {
  const h = document.documentElement;
  const currentTheme = h.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  h.setAttribute('data-theme', newTheme);
  
  // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –∫–Ω–æ–ø–∫–∏
  const btn = document.getElementById('themeBtn');
  btn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
};

document.getElementById('refreshBtn').onclick = () => {
  document.getElementById('loading').style.display = 'flex';
  init();
};

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞
document.getElementById('cmpFilter').onchange = async (e) => {
  try {
    CMP_SELECTED = e.target.value || "";
    await loadComponents();
    setCmpKPI();
    cmpTopIncludedChart();
    cmpByTypeChart();
    cmpTopSuppliersChart();
    cmpTimelineChart();
  } catch (err) { console.error(err); }
};

document.getElementById('cmpFilterReset').onclick = async () => {
  try {
    const sel = document.getElementById('cmpFilter');
    sel.value = "";
    CMP_SELECTED = "";
    await loadComponents();
    setCmpKPI();
    cmpTopIncludedChart();
    cmpByTypeChart();
    cmpTopSuppliersChart();
    cmpTimelineChart();
  } catch (err) { console.error(err); }
};

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
init();
</script>
</body>
</html>
