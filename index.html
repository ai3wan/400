<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –°–≤–æ–¥–Ω—ã–π –î–∞—à–±–æ—Ä–¥ ‚Äî –û–ö–†</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
<style>
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Regular.otf') format('opentype');font-weight:400;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Light.otf') format('opentype');font-weight:300;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Medium.otf') format('opentype');font-weight:500;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Bold.otf') format('opentype');font-weight:700;font-style:normal;font-display:swap}
  @font-face{font-family:'Moscow Sans';src:url('fonts_MoscowSans/MoscowSans-Extrabold.otf') format('opentype');font-weight:800;font-style:normal;font-display:swap}
  :root{
    --c-white:#FFFFFF;
    --c-misty-rose:#F3DCE7;
    --c-tiffany-blue:#92DAD9;
    --c-dark-cyan:#038681;
    --c-midnight-green:#135457;
    --c-space-cadet:#2A3043;
    --c-vermilion:#F34C3F;
    --c-bg:var(--c-white);
    --c-card:var(--c-white);
    --c-text:var(--c-space-cadet);
    --c-primary:var(--c-dark-cyan);
    --c-accent:var(--c-vermilion);
    --c-secondary:var(--c-tiffany-blue);
  }
  [data-theme="dark"]{
    --c-bg:#0b1218;
    --c-card:#111827;
    --c-text:#E5E7EB;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:'Moscow Sans',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-text)}
  .container{max-width:1400px;margin:0 auto;padding:20px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
  .title{font-size:32px;font-weight:700;color:var(--c-primary)}
  .controls{display:flex;gap:12px;align-items:center}
  .card{background:var(--c-card);border-radius:16px;box-shadow:0 2px 8px rgba(42,48,67,.08);padding:16px;border:1px solid rgba(42,48,67,.06)}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
  .kpi-card{text-align:center;padding:20px;background:var(--c-card);border:1px solid rgba(3,134,129,.1)}
  .kpi-value{font-size:28px;font-weight:700;color:var(--c-primary);margin-bottom:4px}
  .kpi-label{font-size:14px;color:var(--c-text);opacity:0.7}
  .delta{font-size:12px;margin-top:4px}
  .delta.up{color:var(--c-primary)} .delta.down{color:var(--c-accent)}
  .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
  .charts-grid.components{margin-top:28px}
  .chart-card{min-height:400px}
  .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--c-text)}
  .chart-container{width:100%;height:350px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:rgba(3,134,129,.12);color:var(--c-primary)}
  .legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
  select, button{padding:8px 10px;border-radius:10px;border:1px solid rgba(42,48,67,.12);background:var(--c-card);color:var(--c-text)}
  .accent{color:var(--c-primary)}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px;border:1px solid rgba(42,48,67,.1)}
  table{width:100%;border-collapse:collapse}
  th, td{padding:10px;border-bottom:1px solid rgba(42,48,67,.08);text-align:left}
  th{font-weight:600;color:var(--c-text);opacity:0.9}
  tr:hover{background:rgba(146,218,217,.05)}
  .tabs{display:flex;gap:8px;margin-bottom:24px;border-bottom:2px solid rgba(42,48,67,.1)}
  .tab{padding:12px 20px;cursor:pointer;border:none;background:transparent;color:var(--c-text);opacity:0.6;font-family:'Moscow Sans',sans-serif;font-size:16px;font-weight:500;border-bottom:3px solid transparent;transition:all 0.2s}
  .tab:hover{opacity:0.8}
  .tab.active{opacity:1;color:var(--c-primary);border-bottom-color:var(--c-primary)}
  .tab-content{display:none}
  .tab-content.active{display:block}
  .calendar-legend{display:flex;gap:20px;margin-top:12px;font-size:13px;color:rgba(42,48,67,.8);flex-wrap:wrap}
  .calendar-legend span{display:flex;align-items:center;gap:6px}
</style>
</head>
<body>
  <!-- Auth Overlay -->
  <div id="authOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:99999;">
    <div style="background:var(--c-card);padding:28px 24px;border-radius:16px;min-width:320px;max-width:420px;">
      <div style="font-size:20px;font-weight:700;margin-bottom:14px;">–í—Ö–æ–¥</div>
      <div style="font-size:13px;opacity:0.8;margin-bottom:12px;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É</div>
      <input id="authInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.1);background:var(--c-card);color:var(--c-text);margin-bottom:12px;">
      <div style="display:flex;gap:10px;">
        <button id="authSubmit" style="flex:1;">–í–æ–π—Ç–∏</button>
        <button id="authReset" style="">–°–±—Ä–æ—Å</button>
      </div>
      <div id="authError" style="color:var(--c-red);font-size:12px;margin-top:8px;display:none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
  </div>

  <div class="container" id="appContainer" style="display:none;">
    <div class="header">
      <h1 class="title">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –°–≤–æ–¥–Ω—ã–π –î–∞—à–±–æ—Ä–¥ ‚Äî –û–ö–†</h1>
      <div class="controls">
        <button id="themeBtn">üåô</button>
        <button id="refreshBtn">üîÑ</button>
        <button id="logoutBtn" title="–í—ã–π—Ç–∏">üö™</button>
    </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="okr">–°—Ç–∞—Ç—É—Å –û–ö–†</button>
      <button class="tab" data-tab="visits">–í—ã–µ–∑–¥—ã</button>
    </div>

    <!-- Tab Content: OKR -->
    <div id="tab-okr" class="tab-content active">
    <!-- KPI (OKR) -->
    <div class="kpi-grid">
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-inwork">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –û–ö–† –≤ —Ä–∞–±–æ—Ç–µ</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-tz">0</div>
        <div class="kpi-label">–ù–∞ —ç—Ç–∞–ø–µ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-oo">0</div>
        <div class="kpi-label">–ù–∞ —ç—Ç–∞–ø–µ –û–ø—ã—Ç–Ω–æ–≥–æ –æ–±—Ä–∞–∑—Ü–∞</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-pi">0</div>
        <div class="kpi-label">–ù–∞ —ç—Ç–∞–ø–µ –ü—Ä–∏–µ–º–æ—á–Ω—ã—Ö –∏—Å–ø—ã—Ç–∞–Ω–∏–π</div>
    </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-ready">0</div>
        <div class="kpi-label">–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –û–ö–†</div>
      </div>
    </div>

    <!-- Phase Progress Pie Charts -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:20px;">
      <div class="card">
        <div class="chart-title">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞–Ω–∏—è</div>
        <div id="phase-pie-tz" class="chart-container"></div>
      </div>
      <div class="card">
        <div class="chart-title">–û–ø—ã—Ç–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü</div>
        <div id="phase-pie-oo" class="chart-container"></div>
      </div>
      <div class="card">
        <div class="chart-title">–ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è</div>
        <div id="phase-pie-pi" class="chart-container"></div>
      </div>
    </div>

    <div class="charts-grid" style="margin-top:20px;">
      <div class="card chart-card">
        <div class="chart-title">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –û–ö–† (–¢–ó / –û–û / –ü–ò / –í—ã–ø–æ–ª–Ω–µ–Ω–æ)</div>
        <div id="okrPhasePie" class="chart-container"></div>
      </div>
    </div>

    <div id="okrPhaseDetails" class="card" style="margin-top:20px;display:none;">
      <div class="chart-title" id="okrPhaseDetailsTitle" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span id="okrPhaseDetailsPhase">–î–µ—Ç–∞–ª–∏ –ø–æ —Ñ–∞–∑–µ</span>
        <button id="okrPhaseDetailsClose" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text);">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>–°–∏—Å—Ç–µ–º–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
              <th>–ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
            </tr>
          </thead>
          <tbody id="okrPhaseDetailsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="chart-title" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span id="okrRiskTitle">üö® –†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - [0]</span>
        <button id="okrRiskToggle" aria-label="toggle" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å/–°–≤–µ—Ä–Ω—É—Ç—å" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text);font-size:16px;line-height:1;">‚ñ∏</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>–°–∏—Å—Ç–µ–º–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–§–∞–∑–∞</th>
              <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th>
              <th>–ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
            </tr>
          </thead>
          <tbody id="okrRiskSoonBody"></tbody>
        </table>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px;">
      <div class="card">
        <div class="chart-title">–¢–æ–ø-5 —Ä–∏—Å–∫–æ–≤ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>
        <div id="okrRiskCompanyBar" class="chart-container"></div>
      </div>
      <div class="card">
        <div class="chart-title">–†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: –ø–æ –º–µ—Å—è—Ü–∞–º</div>
        <div id="okrRiskMonthPie" class="chart-container"></div>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="chart-title">–†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: Treemap –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>
      <div id="okrRiskCompanyTreemap" class="chart-container" style="height:400px;"></div>
    </div>
    </div>
    <!-- End Tab Content: OKR -->

    <!-- Tab Content: –í—ã–µ–∑–¥—ã -->
    <div id="tab-visits" class="tab-content">
      <div id="visitsLoading" style="display:none;align-items:center;justify-content:center;padding:40px;">
        <div style="text-align:center;">
          <div style="font-size:36px;margin-bottom:12px;">üöê</div>
          <div style="font-size:16px;font-weight:600;">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–µ–∑–¥–∞–º...</div>
        </div>
      </div>
      <div id="visitsError" class="card" style="display:none;margin-bottom:20px;background:rgba(243,76,63,0.08);border:1px solid rgba(243,76,63,0.3);">
        <div class="chart-title" style="margin-bottom:8px;">–û—à–∏–±–∫–∞</div>
        <div id="visitsErrorText" style="font-size:14px;"></div>
      </div>
      <div id="visitsContent" style="display:none;">
        <div class="kpi-grid">
          <div class="card kpi-card">
            <div class="kpi-value" id="visits-kpi-total">0</div>
            <div class="kpi-label">–í—Å–µ–≥–æ –≤—ã–µ–∑–¥–æ–≤</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-value" id="visits-kpi-upcoming">0</div>
            <div class="kpi-label">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-value" id="visits-kpi-past">0</div>
            <div class="kpi-label">–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-value" id="visits-kpi-nodate">0</div>
            <div class="kpi-label">–ë–µ–∑ –¥–∞—Ç—ã</div>
          </div>
          <div class="card kpi-card">
            <div class="kpi-value" id="visits-kpi-companies">0</div>
            <div class="kpi-label">–ö–æ–º–ø–∞–Ω–∏–π –≤ –æ—Ö–≤–∞—Ç–µ</div>
          </div>
        </div>

        <div class="card" style="margin-top:24px;">
          <div class="chart-title">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –≤—ã–µ–∑–¥–æ–≤</div>
          <div id="visitsCalendar" class="chart-container" style="height:360px;"></div>
          <div class="calendar-legend">
            <span><span class="legend-dot" style="background:#F34C3F"></span>–ú–æ—Å–∫–≤–∞</span>
            <span><span class="legend-dot" style="background:#038681"></span>–ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞</span>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-top:24px;">
          <div class="card">
            <div class="chart-title">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –º–µ—Å—è—Ü–∞–º</div>
            <div id="visitsMonthly" class="chart-container" style="height:320px;"></div>
          </div>
          <div class="card">
            <div class="chart-title">–¢–æ–ø –≥–æ—Ä–æ–¥–æ–≤ –ø–æ –≤—ã–µ–∑–¥–∞–º</div>
            <div id="visitsByCity" class="chart-container" style="height:320px;"></div>
          </div>
          <div class="card">
            <div class="chart-title">–í—ã–µ–∑–¥—ã –ø–æ —Å–∏—Å—Ç–µ–º–∞–º</div>
            <div id="visitsBySystem" class="chart-container" style="height:320px;"></div>
          </div>
        </div>

        <div class="card" style="margin-top:24px;">
          <div class="chart-title">–ë–ª–∏–∂–∞–π—à–∏–µ –≤—ã–µ–∑–¥—ã (—Ç–µ–∫—É—â–∞—è –∏ 2 —Å–ª–µ–¥—É—é—â–∏–µ –Ω–µ–¥–µ–ª–∏)</div>
          <table>
            <thead>
              <tr>
                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
                <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                <th>–°–∏—Å—Ç–µ–º–∞</th>
                <th>–ì–æ—Ä–æ–¥</th>
                <th>–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody id="visitsRecentBody">
              <tr><td colspan="5" style="text-align:center;opacity:0.7;padding:20px;">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- End Tab Content: –í—ã–µ–∑–¥—ã -->
    </div>
  
  <!-- Loading indicator -->
  <div id="loading" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
      <div style="font-size:18px;font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

<script>
// --- Simple front-only auth gate ---
const AUTH_KEY = 'vsm400_auth_ok';
const AUTH_PASS = 'vsm400';
function showApp(){document.getElementById('authOverlay').style.display='none';document.getElementById('appContainer').style.display='';}
function showAuth(){document.getElementById('appContainer').style.display='none';document.getElementById('authOverlay').style.display='flex';}
function initAuth(){
  const ok = localStorage.getItem(AUTH_KEY)==='1';
  if(ok){showApp();}else{showAuth();}
  document.getElementById('authSubmit').onclick=()=>{const v=(document.getElementById('authInput').value||'').trim();if(v===AUTH_PASS){localStorage.setItem(AUTH_KEY,'1');showApp();init();}else{const e=document.getElementById('authError');e.style.display='';setTimeout(()=>e.style.display='none',1500);}};
  document.getElementById('authReset').onclick=()=>{document.getElementById('authInput').value='';};
  document.getElementById('logoutBtn').onclick=()=>{localStorage.removeItem(AUTH_KEY);location.reload();};
}

let OKR={};
async function loadData(){const res=await fetch('/api/okr/operational-summary');if(!res.ok)throw new Error('HTTP '+res.status);OKR=await res.json();}
function setKPI(){
  const k = OKR.kpi || {};
  document.getElementById('okr-kpi-inwork').innerText = (k.total_in_work || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-tz').innerText = (k.phase_tz || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-oo').innerText = (k.phase_oo || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-pi').innerText = (k.phase_pi || 0).toLocaleString('ru-RU');
  document.getElementById('okr-kpi-ready').innerText = (k.total_ready || 0).toLocaleString('ru-RU');
}

const numberFormatter = new Intl.NumberFormat('ru-RU');
const monthFormatter = new Intl.DateTimeFormat('ru-RU', { month: 'short', year: 'numeric' });
const dateFormatter = new Intl.DateTimeFormat('ru-RU', { day: '2-digit', month: 'short', year: 'numeric' });
let VISITS_DATA = null;
let visitsInitialized = false;
const visitsPalette = ['#038681','#92DAD9','#135457','#2A3043','#F3DCE7','#F34C3F','#2A3043'];

function formatNumber(value){
  const num = Number(value || 0);
  return numberFormatter.format(Number.isFinite(num) ? num : 0);
}

function escapeHTML(value){
  return String(value ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function formatDate(value){
  if(!value) return '‚Äî';
  const date = new Date(value);
  if(Number.isNaN(date.getTime())) return escapeHTML(value);
  return dateFormatter.format(date);
}

function formatMonthLabel(monthStr){
  if(!monthStr) return '‚Äî';
  let date;
  const parts = monthStr.split('-');
  if(parts.length >= 2){
    const y = Number(parts[0]);
    const m = Number(parts[1]) - 1;
    if(Number.isFinite(y) && Number.isFinite(m)){
      date = new Date(Date.UTC(y, m, 1));
    }
  }
  if(!date || Number.isNaN(date.getTime())){
    const fallback = new Date(monthStr);
    if(Number.isNaN(fallback.getTime())) return monthStr;
    date = fallback;
  }
  return monthFormatter.format(date);
}

function parseISODate(dateStr){
  if(!dateStr) return null;
  const parts = String(dateStr).split('-');
  if(parts.length < 3) return null;
  const year = Number(parts[0]);
  const month = Number(parts[1]);
  const day = Number(parts[2]);
  if(!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day)) return null;
  return new Date(Date.UTC(year, month - 1, day));
}

function toISODateString(date){
  if(!(date instanceof Date) || Number.isNaN(date.getTime())) return '';
  const year = date.getUTCFullYear();
  const month = String(date.getUTCMonth() + 1).padStart(2, '0');
  const day = String(date.getUTCDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function getMonday(date){
  const d = new Date(date.getTime());
  const day = d.getUTCDay() || 7;
  if(day !== 1){
    d.setUTCDate(d.getUTCDate() + 1 - day);
  }
  return d;
}

function getISOWeekNumber(date){
  const target = new Date(date.getTime());
  target.setUTCHours(0,0,0,0);
  // Thursday in current week decides the year.
  target.setUTCDate(target.getUTCDate() + 3 - ((target.getUTCDay() + 6) % 7));
  const firstThursday = new Date(Date.UTC(target.getUTCFullYear(),0,4));
  const diff = target - firstThursday;
  return 1 + Math.round(diff / 604800000);
}

function getChartInstance(domId){
  const dom = document.getElementById(domId);
  if(!dom) return null;
  let instance = echarts.getInstanceByDom(dom);
  if(!instance){
    instance = echarts.init(dom);
  }
  if(!dom.dataset.resizeBound){
    window.addEventListener('resize', () => {
      const inst = echarts.getInstanceByDom(dom);
      if(inst){ inst.resize(); }
    });
    dom.dataset.resizeBound = '1';
  }
  return instance;
}

function setVisitsKPI(kpi){
  const data = kpi || {};
  const mapping = [
    ['visits-kpi-total', data.total],
    ['visits-kpi-upcoming', data.upcoming],
    ['visits-kpi-past', data.completed],
    ['visits-kpi-nodate', data.without_date],
    ['visits-kpi-companies', data.unique_companies],
  ];
  mapping.forEach(([id, val]) => {
    const el = document.getElementById(id);
    if(el){ el.textContent = formatNumber(val); }
  });
}

function visitsCalendarChart(){
  const chart = getChartInstance('visitsCalendar');
  if(!chart) return;
  const rawEntries = VISITS_DATA?.calendar || [];
  const range = VISITS_DATA?.calendar_range;
  const rangeValue = (range && range.start && range.end) ? [range.start, range.end] : `${new Date().getFullYear()}`;

  const monthNameMap = ['—è–Ω–≤–∞—Ä—å','—Ñ–µ–≤—Ä–∞–ª—å','–º–∞—Ä—Ç','–∞–ø—Ä–µ–ª—å','–º–∞–π','–∏—é–Ω—å','–∏—é–ª—å','–∞–≤–≥—É—Å—Ç','—Å–µ–Ω—Ç—è–±—Ä—å','–æ–∫—Ç—è–±—Ä—å','–Ω–æ—è–±—Ä—å','–¥–µ–∫–∞–±—Ä—å'];

  const heatmapData = rawEntries.map(item => {
    const count = Number(item.count) || 0;
    const hasMoscow = !!item.has_moscow;
    return {
      value: [item.date, count],
      hasMoscow,
      itemStyle: {
        color: hasMoscow ? '#F34C3F' : (count > 0 ? '#038681' : 'rgba(3,134,129,0.18)')
      }
    };
  });

  const weekNumberData = [];
  if(range && range.start && range.end){
    const startDate = parseISODate(range.start);
    const endDate = parseISODate(range.end);
    if(startDate && endDate){
      const firstMonday = getMonday(startDate);
      for(let current = new Date(firstMonday.getTime()); current <= endDate; current.setUTCDate(current.getUTCDate() + 7)){
        weekNumberData.push({
          value: [toISODateString(current), 0],
          week: getISOWeekNumber(current)
        });
      }
    }
  }

  chart.setOption({
    calendar: {
      top: 60,
      left: 70,
      right: 20,
      bottom: 90,
      cellSize: ['auto', 26],
      range: rangeValue,
      firstDay: 1,
      itemStyle: {
        borderWidth: 1,
        borderColor: 'rgba(19,84,87,0.1)',
        borderRadius: 4
      },
      yearLabel: { show: false },
      monthLabel: {
        margin: 18,
        color: 'var(--c-text)',
        fontFamily: 'Moscow Sans, sans-serif',
        nameMap: monthNameMap
      },
      dayLabel: {
        position: 'top',
        nameMap: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'],
        margin: 16,
        color: 'rgba(19,84,87,0.7)',
        fontFamily: 'Moscow Sans, sans-serif'
      }
    },
    tooltip: {
      position: 'top',
      formatter: (params) => {
        const item = params?.data || {};
        const value = Array.isArray(item.value) ? Number(item.value[1]) || 0 : 0;
        const dateStr = Array.isArray(item.value) ? item.value[0] : null;
        const label = item.hasMoscow ? '–ú–æ—Å–∫–≤–∞' : '–ö–æ–º–∞–Ω–¥–∏—Ä–æ–≤–∫–∞';
        return `${formatDate(dateStr)}: ${formatNumber(value)}<br/>${label}`;
      }
    },
    series: [
      {
        type: 'heatmap',
        coordinateSystem: 'calendar',
        data: heatmapData,
        itemStyle: {
          borderRadius: 6
        },
        encode: { tooltip: 1 },
        emphasis: { focus: 'self' }
      },
      {
        type: 'scatter',
        coordinateSystem: 'calendar',
        symbolSize: 1,
        data: heatmapData.map(item => ({ value: item.value, count: item.value[1] })),
        label: {
          show: true,
          formatter: ({ data }) => (data && data.count ? data.count : ''),
          position: 'inside',
          color: '#FFFFFF',
          fontSize: 12,
          fontFamily: 'Moscow Sans, sans-serif',
          fontWeight: 600
        },
        itemStyle: { color: 'transparent' },
        tooltip: { show: false }
      },
      {
        type: 'scatter',
        coordinateSystem: 'calendar',
        symbolSize: 1,
        data: weekNumberData.map(item => ({ value: item.value, week: item.week })),
        label: {
          show: true,
          formatter: (params) => `${params.data.week}`,
          position: 'top',
          offset: [0, -46],
          color: 'rgba(19,84,87,0.7)',
          fontSize: 12,
          fontFamily: 'Moscow Sans, sans-serif'
        },
        itemStyle: { color: 'transparent' },
        tooltip: { show: false }
      }
    ]
  }, true);
}

function visitsMonthlyChart(){
  const chart = getChartInstance('visitsMonthly');
  if(!chart) return;
  const source = VISITS_DATA?.monthly_counts || [];
  const categories = source.map(item => formatMonthLabel(item.month));
  const values = source.map(item => Number(item.count) || 0);
  chart.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' }
    },
    grid: {
      left: '8%',
      right: '4%',
      bottom: '12%',
      top: '12%'
    },
    xAxis: {
      type: 'category',
      data: categories,
      axisLabel: {
        rotate: categories.length > 6 ? 45 : 0,
        fontFamily: 'Moscow Sans, sans-serif'
      }
    },
    yAxis: {
      type: 'value',
      name: '–ö–æ–ª-–≤–æ',
      nameTextStyle: { fontFamily: 'Moscow Sans, sans-serif' }
    },
    series: [{
      name: '–í—ã–µ–∑–¥—ã',
      type: 'bar',
      data: values,
        itemStyle: {
        color: '#038681',
        borderRadius: [6,6,0,0]
      },
      label: {
        show: true,
        position: 'top',
        formatter: ({ value }) => formatNumber(value)
      }
    }]
  }, true);
}

function visitsByCityChart(){
  const chart = getChartInstance('visitsByCity');
  if(!chart) return;
  const source = (VISITS_DATA?.by_city || []).map(item => ({
    name: item.city || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
    value: Number(item.count) || 0
  }));
  chart.setOption({
    tooltip: {
      trigger: 'axis',
      axisPointer: { type: 'shadow' }
    },
    grid: {
      left: 120,
      right: 20,
      top: 20,
      bottom: 20
    },
    xAxis: { type: 'value' },
    yAxis: {
      type: 'category',
      data: source.map(item => item.name),
      axisLabel: { fontFamily: 'Moscow Sans, sans-serif' }
    },
    series: [{
      type: 'bar',
      data: source.map(item => item.value),
      itemStyle: {
        color: '#135457',
        borderRadius: [0,6,6,0]
      },
      label: {
        show: true,
        position: 'right',
        formatter: ({ value }) => formatNumber(value)
      }
    }]
  }, true);
}

function visitsBySystemChart(){
  const chart = getChartInstance('visitsBySystem');
  if(!chart) return;
  const source = (VISITS_DATA?.by_system || []).map((item, index) => ({
    value: Number(item.count) || 0,
    name: item.system_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
    itemStyle: { color: visitsPalette[index % visitsPalette.length] }
  }));
  const data = source.length ? source : [{ value: 0, name: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', itemStyle: { color: '#E5E7EB' } }];
  chart.setOption({
    tooltip: {
      trigger: 'item',
      formatter: '{b}: {c} ({d}%)'
    },
    legend: {
      bottom: 0,
      type: 'scroll',
      textStyle: { fontFamily: 'Moscow Sans, sans-serif' }
    },
    series: [{
      name: '–°–∏—Å—Ç–µ–º—ã',
      type: 'pie',
      radius: ['40%','70%'],
      center: ['50%','45%'],
      data,
      label: {
        formatter: '{b}: {c}'
      }
    }]
  }, true);
}

function renderVisitsRecent(){
  const tbody = document.getElementById('visitsRecentBody');
  if(!tbody) return;
  const rows = VISITS_DATA?.recent_visits || [];
  if(!rows.length){
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;opacity:0.7;padding:20px;">–î–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç</td></tr>';
    return;
  }
  const rowsHtml = rows.map(item => {
    const dateLabel = formatDate(item.start_date);
    const company = escapeHTML(item.company_name || '‚Äî');
    const system = escapeHTML(item.system_name || '‚Äî');
    const city = escapeHTML(item.city || '‚Äî');
    const comment = escapeHTML(item.comment || item.period || '‚Äî');
    return `<tr>
      <td>${comment}</td>
      <td>${company}</td>
      <td>${system}</td>
      <td>${city}</td>
      <td>${dateLabel}</td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rowsHtml;
}

function renderVisits(){
  const content = document.getElementById('visitsContent');
  if(content){ content.style.display = 'block'; }
  setVisitsKPI(VISITS_DATA?.kpi || {});
  visitsCalendarChart();
  visitsMonthlyChart();
  visitsByCityChart();
  visitsBySystemChart();
  renderVisitsRecent();
}

async function loadVisitsData(force = false){
  if(visitsInitialized && !force){
    renderVisits();
    return;
  }
  const loadingEl = document.getElementById('visitsLoading');
  const contentEl = document.getElementById('visitsContent');
  const errorEl = document.getElementById('visitsError');
  const errorTextEl = document.getElementById('visitsErrorText');
  if(contentEl){ contentEl.style.display = 'none'; }
  if(errorEl){ errorEl.style.display = 'none'; }
  if(loadingEl){ loadingEl.style.display = 'flex'; }
  try{
    const res = await fetch('/api/visits/summary?_ts=' + Date.now(), { cache: 'no-store' });
    if(!res.ok){
      throw new Error('HTTP ' + res.status);
    }
    const data = await res.json();
    VISITS_DATA = data;
    visitsInitialized = true;
    renderVisits();
  }catch(err){
    console.error('loadVisitsData error:', err);
    visitsInitialized = false;
    if(errorEl && errorTextEl){
      errorTextEl.textContent = err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ';
      errorEl.style.display = 'block';
    }
  }finally{
    if(loadingEl){ loadingEl.style.display = 'none'; }
  }
}
async function loadPhaseProgress(){
  try{
    const res = await fetch('/api/okr/phase-progress');
    if(!res.ok) return;
    const data = await res.json();
    const phases = data.phases || [];
    
    // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø–∞–π—á–∞—Ä—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–∞–∑—ã
    phases.forEach(phaseData => {
      const phase = phaseData.phase;
      const progress = phaseData.progress || 0;
      const statuses = phaseData.statuses || [];
      
      let chartId = '';
      if(phase === '–¢–ó') chartId = 'phase-pie-tz';
      else if(phase === '–û–û') chartId = 'phase-pie-oo';
      else if(phase === '–ü–ò') chartId = 'phase-pie-pi';
      else return;
      
      const elDom = document.getElementById(chartId);
      if(!elDom) return;
      
      const el = echarts.init(elDom);
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–π—á–∞—Ä—Ç–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
      const statusMap = {
        '–Ω–µ –Ω–∞—á–∞—Ç–æ': { name: '–ù–µ –Ω–∞—á–∞—Ç–æ', color: '#F34C3F' },
        '–≤ —Ä–∞–±–æ—Ç–µ': { name: '–í —Ä–∞–±–æ—Ç–µ', color: '#038681' },
        '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ': { name: '–í—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#92DAD9' },
        '–Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ': { name: '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#F34C3F' }
      };
      
      const pieData = [];
      statuses.forEach(s => {
        const statusName = (s.status || '').trim();
        const statusKey = statusName.toLowerCase();
        const statusInfo = statusMap[statusKey] ||
          (statusKey.includes('–Ω–µ –≤—ã–ø–æ–ª–Ω') || statusKey.includes('–Ω–µ –Ω–∞—á–∞—Ç–æ') ? { name: statusName || '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', color: '#F34C3F' } : { name: statusName, color: '#6b7280' });
        pieData.push({
          name: statusInfo.name,
          value: s.count || 0,
          itemStyle: { color: statusInfo.color }
        });
      });
      
      // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π –ø–∞–π—á–∞—Ä—Ç
      if(pieData.length === 0){
        el.setOption({
          title: {
            text: `${progress.toFixed(1)}%`,
            left: 'center',
            top: 'center',
            textStyle: {
              fontSize: 32,
              fontWeight: 'bold',
              fontFamily: 'Moscow Sans, sans-serif'
            }
          },
          series: [{
            type: 'pie',
            radius: ['40%', '70%'],
            data: [{ value: 0, name: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' }],
            itemStyle: { color: '#e5e7eb' }
          }]
        }, true);
        return;
      }
  
  el.setOption({
    tooltip: { 
      trigger: 'item',
          formatter: (params) => {
            return `${params.name}<br/>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${params.value}`;
          }
    },
    legend: {
      type: 'scroll',
          bottom: 0,
      textStyle: {
            fontFamily: 'Moscow Sans, sans-serif',
        fontSize: 12
          }
        },
        graphic: [{
          type: 'text',
          left: 'center',
          top: 'center',
          style: {
            text: `${progress.toFixed(1)}%`,
            fontSize: 32,
            fontWeight: 'bold',
            fontFamily: 'Moscow Sans, sans-serif',
            fill: '#1f2937'
          }
        }],
    series: [{
      type: 'pie',
          radius: ['40%', '70%'],
          center: ['50%', '50%'],
        itemStyle: {
            borderRadius: 6,
            borderColor: '#fff',
            borderWidth: 2
      },
      label: {
            show: false
          },
          labelLine: {
            show: false
          },
          data: pieData
        }]
      }, true);
      
      window.addEventListener('resize', () => el.resize());
    });
  }catch(e){ console.error('loadPhaseProgress error:', e); }
}
async function okrPhasePieChart(){
  const el=echarts.init(document.getElementById('okrPhasePie'));
  const res=await fetch('/api/okr/summary-by-phase');
  const payload= res.ok ? await res.json() : {items:[]};
  const raw=(payload.items||[]);
  // –ü–æ—Ä—è–¥–æ–∫ —Ñ–∞–∑ –∏ –±–∞–∫–µ—Ç–æ–≤
  const phaseOrder=["–¢–ó","–û–û","–ü–ò","–í—ã–ø–æ–ª–Ω–µ–Ω–æ"];
  const full={"–¢–ó":"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ","–û–û":"–û–ø—ã—Ç–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü","–ü–ò":"–ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è","–í—ã–ø–æ–ª–Ω–µ–Ω–æ":"–í—ã–ø–æ–ª–Ω–µ–Ω–æ"};
  const bucketOrder=["0","25","50","75","100"];
  const bucketLabels={"0":"0%","25":"25%","50":"50%","75":"75%","100":"100%"};
  const bucketColors={"0":"#F34C3F","25":"#F3DCE7","50":"#92DAD9","75":"#038681","100":"#135457"};

  const sorted = phaseOrder
    .map(p => raw.find(x => (x.phase||'').trim() === p) || {phase:p,total:0,buckets:{"0":0,"25":0,"50":0,"75":0,"100":0}});

  const categories = sorted.map(item => full[item.phase] || item.phase || '‚Äî');

  const series = bucketOrder.map(bucket => ({
    name: bucketLabels[bucket],
    type: 'bar',
    stack: 'total',
    emphasis: { focus: 'series' },
    itemStyle: {
      color: bucketColors[bucket] || '#6b7280',
      borderRadius: bucket === '100' ? [6,6,0,0] : 0
    },
    data: sorted.map(item => (item.buckets && typeof item.buckets[bucket] !== 'undefined') ? item.buckets[bucket] : 0)
  }));

  // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–π–±–ª—ã —Å –æ–±—â–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –Ω–∞ –≤–µ—Ä—Ö–Ω–µ–º –±–∞–∫–µ—Ç–µ
  const lastSeries = series[series.length - 1];
  if(lastSeries){
    lastSeries.label = {
        show: true,
      position: 'top',
      formatter: (params) => {
        const total = sorted[params.dataIndex]?.total || 0;
        return total ? total.toString() : '';
      },
      fontFamily:'Moscow Sans, sans-serif'
    };
  }

  el.setOption({
    tooltip:{
      trigger:'axis',
      axisPointer:{type:'shadow'},
      formatter:(params)=>{
        const idx=params[0]?.dataIndex ?? 0;
        const phaseKey = sorted[idx]?.phase;
        const phaseName = full[phaseKey] || phaseKey || '‚Äî';
        let lines = [`<strong>${phaseName}</strong>`];
        params.forEach(p=>{
          if(p.value){
            lines.push(`${p.marker} ${p.seriesName}: ${p.value}`);
          }
        });
        const total = sorted[idx]?.total || 0;
        lines.push(`–ò—Ç–æ–≥–æ: ${total}`);
        return lines.join('<br/>');
      }
    },
    legend:{
      bottom:0,
      textStyle:{fontFamily:'Moscow Sans, sans-serif'},
      data: bucketOrder.map(b => bucketLabels[b])
    },
    grid:{
      left:'3%',
      right:'4%',
      bottom:'10%',
      containLabel:true
    },
    xAxis:{
      type:'category',
      data:categories,
      axisLabel:{fontFamily:'Moscow Sans, sans-serif'}
    },
    yAxis:{
      type:'value',
      name:'–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
      nameTextStyle:{fontFamily:'Moscow Sans, sans-serif'}
    },
    series
  });

  // –ö–ª–∏–∫ –ø–æ —Ñ–∞–∑–µ –¥–ª—è drill-down
  el.off('click');
  el.on('click', async (params) => {
    const idx = params.dataIndex;
    const phaseKey = sorted[idx]?.phase;
    if(phaseKey){
      await loadPhaseDetails(phaseKey, full[phaseKey] || phaseKey);
    }
  });

  window.addEventListener('resize',()=>el.resize());
}
async function loadPhaseDetails(phase, fullPhaseName){
  try{
    const res=await fetch(`/api/okr/details-by-phase?phase=${encodeURIComponent(phase)}`);
    const payload=res.ok ? await res.json() : {items:[]};
    const rows=payload.items||[];
    const body=document.getElementById('okrPhaseDetailsBody');
    const titleSpan=document.getElementById('okrPhaseDetailsPhase');
    const detailsEl=document.getElementById('okrPhaseDetails');
    if(titleSpan){ titleSpan.innerText=`–î–µ—Ç–∞–ª–∏ –ø–æ —Ñ–∞–∑–µ: ${fullPhaseName}`; }
    const html=rows.map(r=>{
      const dt=(r.end_plan_date||'').slice(0,10)||'‚Äî';
      const progress=Number(r.current_progress||0);
      return `<tr><td>${(r.system_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.supplier_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${dt}</td><td>${progress}%</td></tr>`;
    }).join('');
    body.innerHTML=html||'<tr><td colspan="4" style="opacity:.6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    detailsEl.style.display='block';
  }catch(e){console.error('loadPhaseDetails error:',e);}
}
let RISK_EXPANDED = false;
let RISK_ROWS = [];
async function loadRiskSoon(){
  try{
    const res=await fetch('/api/okr/risk-soon');
    const payload = res.ok ? await res.json() : {items:[]};
    const rows = payload.items || [];
    RISK_ROWS = rows;
    const title=document.getElementById('okrRiskTitle');
    if(title){ title.textContent = `üö® –†–∏—Å–∫–∏ –ø—Ä–æ—Å—Ä–æ—á–∫–∏ - [${rows.length}]`; }
    const body=document.getElementById('okrRiskSoonBody');
    const toShow = RISK_EXPANDED ? rows : rows.slice(0,5);
    const now = new Date();
    const nowYM = now.getFullYear()*100 + now.getMonth();
    const html = toShow.map(r=>{
      const dtStr = (r.end_plan_date||'');
      const dt = dtStr ? new Date(dtStr) : null;
      const ym = dt && !isNaN(dt.getTime()) ? dt.getFullYear()*100 + dt.getMonth() : null;
      const isPastMonth = ym !== null && ym < nowYM;
      const rowStyle = isPastMonth ? ' style="background: rgba(243,76,63,0.10);"' : '';
      const dtDisp = (dtStr||'').slice(0,10) || '‚Äî';
      const progress=Number(r.current_progress||0);
      return `<tr${rowStyle}><td>${(r.system_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.supplier_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.phase||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${dtDisp}</td><td>${progress}%</td></tr>`;
    }).join('');
    const moreRow = (!RISK_EXPANDED && rows.length>5) ? '<tr><td colspan="5" style="text-align:center; opacity:.6;">...</td></tr>' : '';
    body.innerHTML = html + moreRow || '<tr><td colspan="5" style="opacity:.6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    const btn = document.getElementById('okrRiskToggle');
    if(btn){ btn.textContent = RISK_EXPANDED ? '‚ñæ' : '‚ñ∏'; }
    // render company bar chart
    okrRiskCompanyBarChart();
    okrRiskMonthPieChart();
    okrRiskCompanyTreemapChart();
  }catch(e){ console.error('loadRiskSoon error:', e); }
}
function okrRiskCompanyBarChart(){
  try{
    const elDom = document.getElementById('okrRiskCompanyBar');
    if(!elDom){ return; }
    const el = echarts.init(elDom);
    // aggregate by supplier_name and collect systems
    const map = new Map();
    (RISK_ROWS||[]).forEach(r=>{
      const key = (r.supplier_name||'‚Äî');
      if(!map.has(key)){
        map.set(key, {count:0, systems:new Set()});
      }
      map.get(key).count++;
      if(r.system_name) map.get(key).systems.add(r.system_name);
    });
    // convert to array, sort desc, take top 5
    const dataArr = Array.from(map.entries())
      .map(([name,info])=>({name,value:info.count,systems:Array.from(info.systems)}))
      .sort((a,b)=>b.value-a.value)
      .slice(0,5);
    
    if(dataArr.length === 0){
      el.setOption({
        title: { text:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', left:'center', top:'middle', textStyle:{ color:'#999', fontSize:14 } }
      }, true);
      return;
    }
    
    const names = dataArr.map(d=>d.name);
    const values = dataArr.map(d=>d.value);
    const systemsMap = new Map(dataArr.map(d=>[d.name, d.systems]));
  
  el.setOption({
    tooltip: { 
        trigger: 'axis',
        axisPointer: { type: 'shadow' },
        formatter: (params) => {
          const p = params[0];
          const companyName = p.name;
          const systems = systemsMap.get(companyName) || [];
          let tooltipText = `${companyName}<br/>–ü—Ä–æ—Å—Ä–æ—á–µ–∫: ${p.value}`;
          if(systems.length > 0){
            tooltipText += '<br/><br/>–°–∏—Å—Ç–µ–º—ã:<br/>' + systems.map(s=>`‚Ä¢ ${s}`).join('<br/>');
          }
          return tooltipText;
        }
      },
      grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
      },
      xAxis: {
        type: 'value',
        name: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–∫'
      },
      yAxis: {
        type: 'category',
        data: names,
        inverse: true
    },
    series: [{
        name: '–ü—Ä–æ—Å—Ä–æ—á–µ–∫',
        type: 'bar',
        data: values,
        itemStyle: {
          color: (params) => {
            const maxVal = Math.max(...values);
            const minVal = Math.min(...values);
            if(maxVal === minVal) return '#F34C3F';
            const ratio = (params.value - minVal) / (maxVal - minVal);
            // –≥—Ä–∞–¥–∏–µ–Ω—Ç: —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (min) -> –∞–ª—ã–π (max)
            // —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π #92DAD9 = rgb(146,218,217), –∞–ª—ã–π #F34C3F = rgb(243,76,63)
            const r = Math.round(146 + ratio * (243 - 146));
            const g = Math.round(218 - ratio * (218 - 76));
            const b = Math.round(217 - ratio * (217 - 63));
            return `rgb(${r},${g},${b})`;
        }
      },
      label: {
        show: true,
          position: 'right',
          formatter: '{c}'
        }
      }]
    }, true);
    window.addEventListener('resize',()=>el.resize());
  }catch(e){ console.error('okrRiskCompanyBarChart error:', e); }
}
function okrRiskMonthPieChart(){
  try{
    const elDom = document.getElementById('okrRiskMonthPie');
    if(!elDom){ return; }
    const el = echarts.init(elDom);
    // aggregate by month from end_plan_date
    const map = new Map();
    (RISK_ROWS||[]).forEach(r=>{
      const dt = r.end_plan_date || '';
      if(dt){
        const d = new Date(dt);
        if(!isNaN(d.getTime())){
          const monthKey = d.toLocaleDateString('ru-RU',{month:'long',year:'numeric'});
          const sortKey = d.getFullYear() * 100 + d.getMonth(); // –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
          if(!map.has(monthKey)){
            map.set(monthKey, {count:0, sortKey});
          }
          map.get(monthKey).count++;
        }
      }
    });
    // convert to array and sort by date (asc)
    const monthData = Array.from(map.entries())
      .map(([name,info])=>({name, value:info.count, sortKey:info.sortKey}))
      .sort((a,b)=>a.sortKey - b.sortKey);

    const hasData = monthData.length > 0;

    const now = new Date();
    const currentYM = now.getFullYear() * 100 + now.getMonth();
    
    const pieData = monthData.map(m => {
      let color;
      if(m.sortKey < currentYM){
        // –ü—Ä–æ—à–µ–¥—à–∏–µ –º–µ—Å—è—Ü—ã - –∞–ª—ã–π
        color = '#F34C3F';
      }else if(m.sortKey === currentYM){
        // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü - —Ç–µ–º–Ω–æ-–±–∏—Ä—é–∑–æ–≤—ã–π
        color = '#038681';
      }else{
        // –ë—É–¥—É—â–∏–µ –º–µ—Å—è—Ü—ã - —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π
        color = '#92DAD9';
      }
      return {
        name: m.name,
        value: m.value,
        sortKey: m.sortKey,
        itemStyle: { color }
      };
    });

    el.setOption({
      tooltip:{
        trigger:'item',
        formatter:(params)=>`${params.name}: ${params.value} (${params.percent}%)`
      },
      legend:{
        type:'scroll',
        bottom:0,
        textStyle:{ fontFamily:'Moscow Sans, sans-serif' }
      },
      title: hasData ? undefined : { text:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', left:'center', top:'middle', textStyle:{ color:'#999', fontSize:14 } },
      series:[{
        type:'pie',
        radius:['40%','70%'],
        itemStyle:{borderRadius:6,borderColor:'#fff',borderWidth:1},
        label: {
          show: true,
          formatter: (params) => {
            return `{bold|${params.value}}\n${params.name}`;
          },
          fontSize: 12,
          fontFamily: 'Moscow Sans, sans-serif',
          rich: {
            bold: {
              fontSize: 18,
              fontWeight: 'bold',
              fontFamily: 'Moscow Sans, sans-serif'
            }
          }
        },
        data: pieData
      }]
    }, true);
    window.addEventListener('resize',()=>el.resize());
  }catch(e){ console.error('okrRiskMonthPieChart error:', e); }
}
function okrRiskCompanyTreemapChart(){
  try{
    const elDom = document.getElementById('okrRiskCompanyTreemap');
    if(!elDom){ return; }
    const el = echarts.init(elDom);
    // aggregate by supplier_name
    const map = new Map();
    (RISK_ROWS||[]).forEach(r=>{
      const key = (r.supplier_name||'‚Äî');
      map.set(key, (map.get(key)||0)+1);
    });
    // convert to array and get min/max for color mapping
    const dataArr = Array.from(map.entries()).map(([name,count])=>({name,value:count}));
    if(dataArr.length === 0){
      el.setOption({
        title: { text:'–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', left:'center', top:'middle', textStyle:{ color:'#999', fontSize:14 } }
      }, true);
      return;
    }
    const values = dataArr.map(d=>d.value);
    const minVal = Math.min(...values);
    const maxVal = Math.max(...values);
    // color function: —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (min) -> –∞–ª—ã–π (max)
    const getColor = (val) => {
      if(minVal === maxVal) return '#92DAD9'; // —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π if all same
      const ratio = (val - minVal) / (maxVal - minVal);
      // —Å–≤–µ—Ç–ª–æ-–±–∏—Ä—é–∑–æ–≤—ã–π (#92DAD9) to –∞–ª—ã–π (#F34C3F)
      const r = Math.round(146 + ratio * (243 - 146));
      const g = Math.round(218 - ratio * (218 - 76));
      const b = Math.round(217 - ratio * (217 - 63));
      return `rgb(${r},${g},${b})`;
    };
    // add color to each item
    const treemapData = dataArr.map(d=>({
      name: d.name,
      value: d.value,
      itemStyle: { color: getColor(d.value) }
    }));
    el.setOption({
      tooltip: {
        trigger: 'item',
        formatter: (info) => {
          const data = info.data;
          return `${data.name} - ${data.value} –ø—Ä–æ—Å—Ä–æ—á–µ–∫`;
        }
      },
      series: [{
        type: 'treemap',
        data: treemapData,
        roam: false,
        nodeClick: false,
        breadcrumb: { show: false },
        label: {
          show: true,
          formatter: params => params.name,
          fontSize: 12,
          color: '#555',
          textStyle: {
            fontFamily: 'Moscow Sans, sans-serif'
          }
        },
        itemStyle: {
          borderColor: '#fff',
          borderWidth: 2,
          gapWidth: 2
        },
        emphasis: {
          itemStyle: {
            borderColor: '#333',
            borderWidth: 3
          },
          label: { 
            color: '#555',
            textStyle: {
              fontFamily: 'Moscow Sans, sans-serif'
            }
          }
        }
      }]
    }, true);
    window.addEventListener('resize',()=>el.resize());
  }catch(e){ console.error('okrRiskCompanyTreemapChart error:', e); }
}
// Toggle handler
const riskToggleBtn = document.getElementById('okrRiskToggle');
if(riskToggleBtn){ riskToggleBtn.onclick = async ()=>{ RISK_EXPANDED = !RISK_EXPANDED; await loadRiskSoon(); }; }

// Tab switching
function initTabs(){
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.onclick = () => {
      const tabName = tab.getAttribute('data-tab');
      // Update active tab
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      // Update active content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      const targetContent = document.getElementById(`tab-${tabName}`);
      if(targetContent){
        targetContent.classList.add('active');
        // Initialize chart if visits tab
        if(tabName === 'visits'){
          setTimeout(() => loadVisitsData(), 100);
        }
      }
    };
  });
}

async function init(){try{await loadData();setKPI();await loadPhaseProgress();await okrPhasePieChart();await loadRiskSoon();document.getElementById('loading').style.display='none';}catch(e){console.error(e);document.getElementById('loading').innerHTML='<div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;"><div style="font-size:48px;margin-bottom:16px;">‚ùå</div><div style="font-size:18px;font-weight:600;color:var(--c-accent);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div><div style="margin-top:12px;">'+e.message+'</div></div>';}}
document.getElementById('themeBtn').onclick=()=>{const h=document.documentElement;const t=h.getAttribute('data-theme');const n=t==='dark'?'light':'dark';h.setAttribute('data-theme',n);document.getElementById('themeBtn').textContent=n==='dark'?'‚òÄÔ∏è':'üåô';};
document.getElementById('refreshBtn').onclick=async()=>{
  document.getElementById('loading').style.display='flex';
  await init();
  if(visitsInitialized){
    await loadVisitsData(true);
  }
};
const closeBtn=document.getElementById('okrPhaseDetailsClose');
if(closeBtn){ closeBtn.onclick=()=>{ const el=document.getElementById('okrPhaseDetails'); if(el){ el.style.display='none'; } }; }
initTabs();
initAuth();
if(localStorage.getItem(AUTH_KEY)==='1'){init();}
</script>
</body>
</html>
