<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –°–≤–æ–¥–Ω—ã–π –î–∞—à–±–æ—Ä–¥ ‚Äî –û–ö–†</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
<style>
  :root{--c-teal:#16BDCA;--c-blue:#2563EB;--c-red:#EF4444;--c-bg:#f8fafc;--c-card:#fff;--c-text:#0f172a}
  [data-theme="dark"]{--c-bg:#0b1218;--c-card:#111827;--c-text:#E5E7EB}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-text)}
  .container{max-width:1400px;margin:0 auto;padding:20px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
  .title{font-size:32px;font-weight:700;background:linear-gradient(90deg,var(--c-teal),var(--c-blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .controls{display:flex;gap:12px;align-items:center}
  .card{background:var(--c-card);border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.12);padding:16px}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
  .kpi-card{text-align:center;padding:20px}
  .kpi-value{font-size:28px;font-weight:700;color:var(--c-teal);margin-bottom:4px}
  .kpi-label{font-size:14px;color:var(--c-text);opacity:0.7}
  .delta{font-size:12px;margin-top:4px}
  .delta.up{color:var(--c-teal)} .delta.down{color:var(--c-red)}
  .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
  .charts-grid.components{margin-top:28px}
  .chart-card{min-height:400px}
  .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--c-text)}
  .chart-container{width:100%;height:350px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px; background:rgba(37,99,235,.12); color:var(--c-blue)}
  .legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
  select, button{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text)}
  .accent{background: linear-gradient(90deg, var(--c-teal), var(--c-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px; border:1px solid rgba(0,0,0,.1)}
  table{width:100%;border-collapse:collapse}
  th, td{padding:10px;border-bottom:1px solid rgba(0,0,0,.06);text-align:left}
  th{font-weight:600;color:var(--c-text);opacity:0.9}
  tr:hover{background:rgba(0,0,0,.02)}
</style>
</head>
<body>
  <!-- Auth Overlay -->
  <div id="authOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:99999;">
    <div style="background:var(--c-card);padding:28px 24px;border-radius:16px;min-width:320px;max-width:420px;">
      <div style="font-size:20px;font-weight:700;margin-bottom:14px;">–í—Ö–æ–¥</div>
      <div style="font-size:13px;opacity:0.8;margin-bottom:12px;">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞—à–±–æ—Ä–¥—É</div>
      <input id="authInput" type="password" placeholder="–ü–∞—Ä–æ–ª—å" style="width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,.1);background:var(--c-card);color:var(--c-text);margin-bottom:12px;">
      <div style="display:flex;gap:10px;">
        <button id="authSubmit" style="flex:1;">–í–æ–π—Ç–∏</button>
        <button id="authReset" style="">–°–±—Ä–æ—Å</button>
      </div>
      <div id="authError" style="color:var(--c-red);font-size:12px;margin-top:8px;display:none;">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
    </div>
  </div>

  <div class="container" id="appContainer" style="display:none;">
    <div class="header">
      <h1 class="title">–û–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –°–≤–æ–¥–Ω—ã–π –î–∞—à–±–æ—Ä–¥ ‚Äî –û–ö–†</h1>
      <div class="controls">
        <button id="themeBtn">üåô</button>
        <button id="refreshBtn">üîÑ</button>
        <button id="logoutBtn" title="–í—ã–π—Ç–∏">üö™</button>
    </div>
    </div>

    <!-- KPI (OKR) -->
    <div class="kpi-grid">
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-inwork">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –û–ö–† –≤ —Ä–∞–±–æ—Ç–µ</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-done">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-ready">0</div>
        <div class="kpi-label">–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –û–ö–†</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-overdue">0</div>
        <div class="kpi-label">–° –Ω–∞—Ä—É—à–µ–Ω–∏–µ–º —Å—Ä–æ–∫–∞ (–≥–æ—Ä—è—â–∏–µ)</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="okr-kpi-avg">0%</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–≤ —Ä–∞–±–æ—Ç–µ)</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="card chart-card">
        <div class="chart-title">–í–æ—Ä–æ–Ω–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º</div>
        <div id="okrFunnel" class="chart-container"></div>
      </div>
      <div class="card chart-card">
        <div class="chart-title">–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ –û–ö–† (–¢–ó / –û–û / –ü–ò)</div>
        <div id="okrPhasePie" class="chart-container"></div>
      </div>
    </div>

    <div id="okrPhaseDetails" class="card" style="margin-top:20px;display:none;">
      <div class="chart-title" id="okrPhaseDetailsTitle" style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <span>–î–µ—Ç–∞–ª–∏ –ø–æ —Ñ–∞–∑–µ</span>
        <button id="okrPhaseDetailsClose" style="padding:6px 10px;border-radius:8px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text);">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>–°–∏—Å—Ç–µ–º–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
              <th>–ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
            </tr>
          </thead>
          <tbody id="okrPhaseDetailsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card" style="margin-top:20px;">
      <div class="chart-title">–¢–æ–ø-5 –≥–æ—Ä—è—â–∏—Ö –∑–∞–¥–∞—á</div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>–°–∏—Å—Ç–µ–º–∞</th>
              <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
              <th>–§–∞–∑–∞</th>
              <th>–ü–ª–∞–Ω–æ–≤–∞—è –¥–∞—Ç–∞</th>
              <th>–î–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏</th>
            </tr>
          </thead>
          <tbody id="okrOverdueBody"></tbody>
        </table>
      </div>
    </div>
    </div>
  
  <!-- Loading indicator -->
  <div id="loading" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
      <div style="font-size:18px;font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

<script>
// --- Simple front-only auth gate ---
const AUTH_KEY = 'vsm400_auth_ok';
const AUTH_PASS = 'vsm400';
function showApp(){document.getElementById('authOverlay').style.display='none';document.getElementById('appContainer').style.display='';}
function showAuth(){document.getElementById('appContainer').style.display='none';document.getElementById('authOverlay').style.display='flex';}
function initAuth(){
  const ok = localStorage.getItem(AUTH_KEY)==='1';
  if(ok){showApp();}else{showAuth();}
  document.getElementById('authSubmit').onclick=()=>{const v=(document.getElementById('authInput').value||'').trim();if(v===AUTH_PASS){localStorage.setItem(AUTH_KEY,'1');showApp();init();}else{const e=document.getElementById('authError');e.style.display='';setTimeout(()=>e.style.display='none',1500);}};
  document.getElementById('authReset').onclick=()=>{document.getElementById('authInput').value='';};
  document.getElementById('logoutBtn').onclick=()=>{localStorage.removeItem(AUTH_KEY);location.reload();};
}

let OKR={};
async function loadData(){const res=await fetch('/api/okr/operational-summary');if(!res.ok)throw new Error('HTTP '+res.status);OKR=await res.json();}
function setKPI(){const k=OKR.kpi||{};document.getElementById('okr-kpi-inwork').innerText=(k.total_in_work||0).toLocaleString('ru-RU');document.getElementById('okr-kpi-done').innerText=(k.total_done||0).toLocaleString('ru-RU');document.getElementById('okr-kpi-ready').innerText=(k.total_ready||0).toLocaleString('ru-RU');document.getElementById('okr-kpi-overdue').innerText=(k.overdue_now||0).toLocaleString('ru-RU');document.getElementById('okr-kpi-avg').innerText=((k.avg_progress_in_work||0).toFixed(0))+'%';}
async function okrFunnelChart(){
  const el=echarts.init(document.getElementById('okrFunnel'));
  // –ë–µ—Ä—ë–º –∏–∑ –Ω–æ–≤–æ–≥–æ API, —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞—Ç—å current_phase + current_progress –∏ –ø–æ—Ä—è–¥–æ–∫
  const res = await fetch('/api/okr/funnel');
  const payload = res.ok ? await res.json() : { items: [] };
  const rows = payload.items || [];
  const full={"–¢–ó":"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ","–û–û":"–û–ø—ã—Ç–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü","–ü–ò":"–ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è"};
  const phaseColor={"–¢–ó":"#2563EB","–û–û":"#16BDCA","–ü–ò":"#10b981"};
  const data = rows.map(r=>({
    name: `${r.phase || '‚Äî'} ‚Äî ${Number(r.progress||0)}%`,
    value: r.count || 0,
    rawPhase: r.phase || '‚Äî',
    progress: Number(r.progress||0),
    fullPhase: full[r.phase||''] || (r.phase||'‚Äî'),
    itemStyle: { color: phaseColor[r.phase||''] || '#6b7280' }
  }));
  el.setOption({
    tooltip:{ trigger:'item', formatter:(p)=>`${p.data.fullPhase} [${p.data.progress}%] - ${p.data.value}` },
    series:[{
      type:'funnel',
      sort:'none', // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫, –∫–∞–∫ –ø—Ä–∏—à—ë–ª (–¢–ó‚Üí–û–û‚Üí–ü–ò –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
      gap:4,
      label:{ show:true, formatter:(p)=>`${p.data.rawPhase} [${p.data.progress}%] - ${p.data.value}` },
      itemStyle:{ borderRadius:6 },
      data
    }]
  });
  window.addEventListener('resize',()=>el.resize());
}
async function okrPhasePieChart(){
  const el=echarts.init(document.getElementById('okrPhasePie'));
  const res=await fetch('/api/okr/summary-by-phase');
  const payload= res.ok ? await res.json() : {items:[]};
  const raw=(payload.items||[]);
  // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ñ–∞–∑
  const order={"–¢–ó":1,"–û–û":2,"–ü–ò":3};
  const full={"–¢–ó":"–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ","–û–û":"–û–ø—ã—Ç–Ω—ã–π –æ–±—Ä–∞–∑–µ—Ü","–ü–ò":"–ü—Ä–∏–µ–º–æ—á–Ω—ã–µ –∏—Å–ø—ã—Ç–∞–Ω–∏—è"};
  const data=raw.sort((a,b)=> (order[a.phase||'']||99)-(order[b.phase||'']||99))
               .map(x=>({name: (x.phase||'‚Äî'), value:x.count||0}));
  el.setOption({
    tooltip:{trigger:'item',formatter:'{b}: {c} ({d}%)'},
    legend:{bottom:0, formatter: function(name){ return full[name] || name; }},
    series:[{type:'pie',radius:['40%','70%'],itemStyle:{borderRadius:6,borderColor:'#fff',borderWidth:1},data}]
  });
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è drill-down
  el.on('click', async (params) => {
    const phase = params.name;
    await loadPhaseDetails(phase, full[phase] || phase);
  });
  window.addEventListener('resize',()=>el.resize());
}
async function loadPhaseDetails(phase, fullPhaseName){
  try{
    const res=await fetch(`/api/okr/details-by-phase?phase=${encodeURIComponent(phase)}`);
    const payload=res.ok ? await res.json() : {items:[]};
    const rows=payload.items||[];
    const body=document.getElementById('okrPhaseDetailsBody');
    const titleEl=document.getElementById('okrPhaseDetailsTitle');
    const detailsEl=document.getElementById('okrPhaseDetails');
    titleEl.innerText=`–î–µ—Ç–∞–ª–∏ –ø–æ —Ñ–∞–∑–µ: ${fullPhaseName}`;
    const html=rows.map(r=>{
      const dt=(r.end_plan_date||'').slice(0,10)||'‚Äî';
      const progress=Number(r.current_progress||0);
      return `<tr><td>${(r.system_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${(r.supplier_name||'‚Äî').replace(/\"/g,'&quot;')}</td><td>${dt}</td><td>${progress}%</td></tr>`;
    }).join('');
    body.innerHTML=html||'<tr><td colspan="4" style="opacity:.6;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
    detailsEl.style.display='block';
  }catch(e){console.error('loadPhaseDetails error:',e);}
}
async function init(){try{await loadData();setKPI();okrFunnelChart();await okrPhasePieChart();const body=document.getElementById('okrOverdueBody');const rows=(OKR.top_overdue||[]).map(r=>{const dt=(r.end_plan_date||'').slice(0,10);return `<tr><td>${r.id}</td><td>${(r.system_name||'').replace(/\"/g,'&quot;')}</td><td>${(r.supplier||'').replace(/\"/g,'&quot;')}</td><td>${(r.work_phase||'').replace(/\"/g,'&quot;')}</td><td>${dt}</td><td>${r.days_overdue}</td></tr>`;}).join('');body.innerHTML=rows||'<tr><td colspan="6" style="opacity:.6;">–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</td></tr>';document.getElementById('loading').style.display='none';}catch(e){console.error(e);document.getElementById('loading').innerHTML='<div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;"><div style="font-size:48px;margin-bottom:16px;">‚ùå</div><div style="font-size:18px;font-weight:600;color:var(--c-red);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div><div style="margin-top:12px;">'+e.message+'</div></div>';}}
document.getElementById('themeBtn').onclick=()=>{const h=document.documentElement;const t=h.getAttribute('data-theme');const n=t==='dark'?'light':'dark';h.setAttribute('data-theme',n);document.getElementById('themeBtn').textContent=n==='dark'?'‚òÄÔ∏è':'üåô';};
document.getElementById('refreshBtn').onclick=()=>{document.getElementById('loading').style.display='flex';init();};
const closeBtn=document.getElementById('okrPhaseDetailsClose');
if(closeBtn){ closeBtn.onclick=()=>{ const el=document.getElementById('okrPhaseDetails'); if(el){ el.style.display='none'; } }; }
initAuth();
if(localStorage.getItem(AUTH_KEY)==='1'){init();}
</script>
</body>
</html>
