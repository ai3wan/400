<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–î–∞—à–±–æ—Ä–¥ –∫–æ–º–ø–∞–Ω–∏–π</title>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <style>
  :root{--c-teal:#16BDCA;--c-blue:#2563EB;--c-red:#EF4444;--c-bg:#0b1218;--c-card:#111827;--c-text:#E5E7EB}
  [data-theme="light"]{--c-bg:#f8fafc;--c-card:#fff;--c-text:#0f172a}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--c-bg);color:var(--c-text)}
  .container{max-width:1400px;margin:0 auto;padding:20px}
  .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px}
  .title{font-size:32px;font-weight:700;background:linear-gradient(90deg,var(--c-teal),var(--c-blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .controls{display:flex;gap:12px;align-items:center}
  .card{background:var(--c-card);border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.12);padding:16px}
  .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:32px}
  .kpi-card{text-align:center;padding:20px}
  .kpi-value{font-size:28px;font-weight:700;color:var(--c-teal);margin-bottom:4px}
  .kpi-label{font-size:14px;color:var(--c-text);opacity:0.7}
  .delta{font-size:12px;margin-top:4px}
  .delta.up{color:var(--c-teal)} .delta.down{color:var(--c-red)}
  .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px}
  .chart-card{min-height:400px}
  .chart-title{font-size:18px;font-weight:600;margin-bottom:16px;color:var(--c-text)}
  .chart-container{width:100%;height:350px}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px; background:rgba(37,99,235,.12); color:var(--c-blue)}
  .legend-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px}
  select, button{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.08);background:var(--c-card);color:var(--c-text)}
  .accent{background: linear-gradient(90deg, var(--c-teal), var(--c-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
  .pill{padding:4px 8px;border-radius:999px;font-size:12px;margin-left:8px; border:1px solid rgba(0,0,0,.1)}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">–î–∞—à–±–æ—Ä–¥ –∫–æ–º–ø–∞–Ω–∏–π</h1>
      <div class="controls">
        <button id="themeBtn">üåô</button>
        <button id="refreshBtn">üîÑ</button>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-total">0</div>
        <div class="kpi-label">–í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-ido">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –ò–î–û</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-ifr">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –ò–§–†</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-ipd">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –ò–ü–î</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-avg-capital">0</div>
        <div class="kpi-label">–°—Ä–µ–¥–Ω–∏–π –∫–∞–ø–∏—Ç–∞–ª</div>
      </div>
      <div class="card kpi-card">
        <div class="kpi-value" id="kpi-low-risk">0</div>
        <div class="kpi-label">–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º -->
      <div class="card chart-card">
        <div class="chart-title">–ö–æ–º–ø–∞–Ω–∏–∏ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</div>
        <div id="regionChart" class="chart-container"></div>
      </div>

      <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∏—Å–∫–∞–º -->
      <div class="card chart-card">
        <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∏—Å–∫–∞–º</div>
        <div id="riskChart" class="chart-container"></div>
      </div>

      <!-- –¢–æ–ø –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –∫–∞–ø–∏—Ç–∞–ª—É -->
      <div class="card chart-card">
        <div class="chart-title">–¢–æ–ø-10 –∫–æ–º–ø–∞–Ω–∏–π –ø–æ –∫–∞–ø–∏—Ç–∞–ª—É</div>
        <div id="capitalChart" class="chart-container"></div>
      </div>

      <!-- –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ä–∏—Å–∫-–∫–∞–ø–∏—Ç–∞–ª -->
      <div class="card chart-card">
        <div class="chart-title">–ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Ä–∏—Å–∫-–∫–∞–ø–∏—Ç–∞–ª</div>
        <div id="correlationChart" class="chart-container"></div>
      </div>

      <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ò–î–û -->
      <div class="card chart-card">
        <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ò–î–û</div>
        <div id="idoChart" class="chart-container"></div>
      </div>

      <!-- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∫–∞–ø–∏—Ç–∞–ª–∞ -->
      <div class="card chart-card">
        <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∫–∞–ø–∏—Ç–∞–ª–∞</div>
        <div id="capitalSizeChart" class="chart-container"></div>
      </div>
    </div>
  </div>

  <!-- Loading indicator -->
  <div id="loading" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
    <div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;">
      <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
      <div style="font-size:18px;font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>
  </div>

<script>
let DATA = {};

async function loadData() {
  try {
    const response = await fetch('/400/api/dashboard-data');
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    DATA = await response.json();
    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', DATA);
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    throw error;
  }
}

function setKPI() {
  document.getElementById('kpi-total').innerText = (DATA.kpi?.total_companies || 0).toLocaleString('ru-RU');
  document.getElementById('kpi-avg-ido').innerText = (DATA.kpi?.avg_ido || 0).toFixed(1);
  document.getElementById('kpi-avg-ifr').innerText = (DATA.kpi?.avg_ifr || 0).toFixed(1);
  document.getElementById('kpi-avg-ipd').innerText = (DATA.kpi?.avg_ipd || 0).toFixed(1);
  document.getElementById('kpi-avg-capital').innerText = ((DATA.kpi?.avg_capital || 0) / 1000000).toFixed(1) + '–ú';
  document.getElementById('kpi-low-risk').innerText = (DATA.kpi?.low_risk_count || 0).toLocaleString('ru-RU');
}

function regionChart() {
  const el = echarts.init(document.getElementById('regionChart'));
  const data = DATA.companies_by_region || [];
  el.setOption({
    tooltip: { trigger: 'item' },
    series: [{
      type: 'pie',
      radius: ['40%', '70%'],
      itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 1 },
      data: data.map(x => ({ name: x.region || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', value: x.count || 0 }))
    }]
  });
  window.addEventListener('resize', () => el.resize());
}

function riskChart() {
  const el = echarts.init(document.getElementById('riskChart'));
  const data = DATA.companies_by_risk || [];
  const colors = {
    '–ù–∏–∑–∫–∏–π': '#10b981',
    '–°—Ä–µ–¥–Ω–∏–π': '#f59e0b', 
    '–í—ã—Å–æ–∫–∏–π': '#ef4444',
    '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π': '#dc2626'
  };
  el.setOption({
    tooltip: { trigger: 'item' },
    series: [{
      type: 'pie',
      radius: ['40%', '70%'],
      itemStyle: { borderRadius: 6, borderColor: '#fff', borderWidth: 1 },
      data: data.map(x => ({ 
        name: x.spark_risk || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', 
        value: x.count || 0,
        itemStyle: { color: colors[x.spark_risk] || '#6b7280' }
      }))
    }]
  });
  window.addEventListener('resize', () => el.resize());
}

function capitalChart() {
  const el = echarts.init(document.getElementById('capitalChart'));
  const data = DATA.top_companies_by_capital || [];
  el.setOption({
    tooltip: { trigger: 'axis' },
    xAxis: { type: 'category', data: data.map(x => x.short_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') },
    yAxis: { type: 'value', name: '–ö–∞–ø–∏—Ç–∞–ª (–º–ª–Ω ‚ÇΩ)' },
    series: [{
      type: 'bar',
      data: data.map(x => ((x.authorized_capital || 0) / 1000000).toFixed(1)),
      itemStyle: { borderRadius: [4, 4, 0, 0] }
    }]
  });
  window.addEventListener('resize', () => el.resize());
}

function correlationChart() {
  const el = echarts.init(document.getElementById('correlationChart'));
  const data = DATA.risk_capital_correlation || [];
  const colors = {
    '–ù–∏–∑–∫–∏–π': '#10b981',
    '–°—Ä–µ–¥–Ω–∏–π': '#f59e0b',
    '–í—ã—Å–æ–∫–∏–π': '#ef4444', 
    '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π': '#dc2626'
  };
  el.setOption({
    tooltip: { trigger: 'item' },
    xAxis: { type: 'value', name: '–ö–∞–ø–∏—Ç–∞–ª (–º–ª–Ω ‚ÇΩ)' },
    yAxis: { type: 'value', name: '–ò–î–û' },
    series: [{
      type: 'scatter',
      data: data.map(x => [
        ((x.authorized_capital || 0) / 1000000).toFixed(1),
        x.ido || 0,
        x.short_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
        x.spark_risk || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
      ]),
      symbolSize: 8,
      itemStyle: {
        color: function(params) {
          return colors[params.data[3]] || '#6b7280';
        }
      }
    }]
  });
  window.addEventListener('resize', () => el.resize());
}

function idoChart() {
  const el = echarts.init(document.getElementById('idoChart'));
  const data = DATA.ido_distribution || [];
  el.setOption({
    tooltip: { trigger: 'item' },
    xAxis: { type: 'category', data: data.map(x => x.ido_group || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') },
    yAxis: { type: 'value' },
    series: [{
      type: 'bar',
      data: data.map(x => x.count || 0),
      itemStyle: { borderRadius: [4, 4, 0, 0] }
    }]
  });
  window.addEventListener('resize', () => el.resize());
}

function capitalSizeChart() {
  const el = echarts.init(document.getElementById('capitalSizeChart'));
  const data = DATA.capital_distribution || [];
  el.setOption({
    tooltip: { trigger: 'item' },
    xAxis: { type: 'category', data: data.map(x => x.capital_group || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') },
    yAxis: { type: 'value' },
    series: [{
      type: 'bar',
      data: data.map(x => x.count || 0),
      itemStyle: { borderRadius: [4, 4, 0, 0] }
    }]
  });
  window.addEventListener('resize', () => el.resize());
}

async function init() {
  try {
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...');
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
    console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ...');
    await loadData();
    console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', DATA);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ try-catch
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º setKPI...');
      setKPI(); 
      console.log('setKPI –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ setKPI:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º regionChart...');
      regionChart(); 
      console.log('regionChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ regionChart:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º riskChart...');
      riskChart();
      console.log('riskChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ riskChart:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º capitalChart...');
      capitalChart(); 
      console.log('capitalChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ capitalChart:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º correlationChart...');
      correlationChart();
      console.log('correlationChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ correlationChart:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º idoChart...');
      idoChart(); 
      console.log('idoChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ idoChart:', e);
    }
    
    try {
      console.log('–í—ã–∑—ã–≤–∞–µ–º capitalSizeChart...');
      capitalSizeChart();
      console.log('capitalSizeChart –≤—ã–ø–æ–ª–Ω–µ–Ω');
    } catch (e) {
      console.error('–û—à–∏–±–∫–∞ –≤ capitalSizeChart:', e);
    }
    
    // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('loading').style.display = 'none';
    console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    console.error('Stack trace:', error.stack);
    document.getElementById('loading').innerHTML = '<div style="background:var(--c-card);padding:32px;border-radius:16px;text-align:center;"><div style="font-size:48px;margin-bottom:16px;">‚ùå</div><div style="font-size:18px;font-weight:600;color:var(--c-red);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div><div style="margin-top:12px;">'+error.message+'</div></div>';
  }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
document.getElementById('themeBtn').onclick = () => {
  const h = document.documentElement;
  h.setAttribute('data-theme', h.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
};

document.getElementById('refreshBtn').onclick = () => {
  document.getElementById('loading').style.display = 'flex';
  init();
};

// –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
init();
</script>
</body>
</html>
